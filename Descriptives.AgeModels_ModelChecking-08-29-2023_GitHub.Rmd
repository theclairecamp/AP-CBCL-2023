---
title: 'Descriptives + CBCL~Age+Covariates Models with Model Checking'
author: "Claire Campbell; prior data cleaning by Hedyeh Ahmadi"
date: "Version `r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    fig_caption: yes
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: no
  word_document:
    toc: yes
    toc_depth: '4'
  pdf_document:
    toc: yes
    toc_depth: '4'
editor_options:
  chunk_output_rype: console
  chunk_output_type: console
---

<style type="text/css">

body, td {
   font-size: 13px;
}
code.r{
  font-size: 11px;
}
pre {
  font-size: 11px
}
</style>

# R set up

```{r setup, echo=F}
knitr::opts_chunk$set(echo = TRUE)
#Clear existing data and graphics
rm(list = ls(all.names = TRUE)) #will clear all objects includes hidden objects.
graphics.off()
invisible(gc()) #free up memory and report the memory usage.
```

Activate renv to create renv.lock file to track dependencies for data reproducibility
```{r eval=F}
renv::init()
```

If downloading project from github and want to restore previous dependencies used for analyses run this line
```{r eval=F}
renv::restore()
```

Download packages so stored in renv.lock file
```{r eval=F}
# To create Pdf
install.packages("knitr")

# Importing Data
install.packages("haven")
install.packages("readxl")

# Table specific
install.packages("xtable")
install.packages("kableExtra")

# Data Cleaning and plotting
install.packages("tidyverse")
install.packages("dplyr")
install.packages("plyr")
install.packages("ggplot2")
install.packages("scales")
install.packages("gridExtra")

# Skewness install.packages
install.packages("e1071")

# Matrix operations
install.packages("matrixStats")

# Mixed Models
install.packages("lme4")
install.packages("nlme")
#install.packages("HLMdiag") # Model diagnostics

# To read the lables
install.packages("Hmisc")

# to order the data
install.packages("doBy")

# to re-code variables
install.packages("rockchalk")

# for reshape
install.packages("MASS")

# descriptive and more
install.packages("psych")

# correlogram plot
install.packages("corrplot")

#glmer diagnostics
install.packages("fitdistrplus")

#outlier analysis and R^2
install.packages("performance")
install.packages("rptR")

# Creating stratified tables
install.packages("arsenal")

#For zero-inflated negative binomial modeling/model checking
install.packages("remotes")
library(remotes)
install_github("nyiuab/NBZIMM", force=T, build_vignettes=F)
install.packages("philentropy")
```

Load in libraries
```{r echo=F}
# To create Pdf
library(knitr)

# Importing Data
library(haven)
library(readxl)

# Table specific
library(xtable)
library(kableExtra)

# Data Cleaning and plotting
library(tidyverse)
library(dplyr)
library(plyr)
library(ggplot2)
library(scales)
library(gridExtra)

# Skewness library
library(e1071)

# Matrix operations
library(matrixStats)

# Mixed Models
library(lme4)
library(nlme)
#require (HLMdiag) # Model diagnostics

# To read the lables
library(Hmisc)

# to order the data
library(doBy)

# to re-code variables
library(rockchalk)

# for reshape
library(MASS)

# descriptive and more
library(psych)

# correlogram plot
library(corrplot)

#glmer diagnostics
library("fitdistrplus")

#outlier analysis and R^2
library(performance)

# Creating stratified tables
library(arsenal)

#For zero-inflated negative binomial modeling/model checking
library(NBZIMM)
library(philentropy)
```

# Importing the Clean Data
Note that the data cleaning and exploration for this analysis is in a separate file written by Hedyeh Ahmadi.
```{r}
HEI_Aim2_Long <- read.csv("HEI_Aim2_Long.csv")
HEI_Aim2_Wide <- read.csv("HEI_Aim2_Wide.csv")

HEI_Aim2_Long_1KidPerFamily <- read.csv("HEI_Aim2_Long_1KidPerFamily.csv")
dim(HEI_Aim2_Long)
dim(HEI_Aim2_Wide)
dim(HEI_Aim2_Long_1KidPerFamily)


names(HEI_Aim2_Long)
names(HEI_Aim2_Wide)
names(HEI_Aim2_Long_1KidPerFamily)


# Note we are keeping all families but choosing one kid per family
length(unique(HEI_Aim2_Long$rel_family_id))
length(unique(HEI_Aim2_Long$subjectid)) # matches number of rows of wide data :)

length(unique(HEI_Aim2_Long_1KidPerFamily$rel_family_id))
length(unique(HEI_Aim2_Long_1KidPerFamily$subjectid))
```

## Copy baseline variables to all timepoints for full df
```{r}
#rename so can use later
names(HEI_Aim2_Long)[names(HEI_Aim2_Long) == 'prnt.empl.bl'] <- 'prnt.empl.b'

#create dataset for table and comparison
baseline_vars <- subset(HEI_Aim2_Long, HEI_Aim2_Long$eventname=="Baseline", select = c("subjectid", "sex", "race_ethnicity", "high.educ", "neighb_phenx_avg_p", "overall.income.b", "prnt.empl.b"))

#rename variables
names(baseline_vars)[names(baseline_vars) == 'sex'] <- 'sex.bl'
names(baseline_vars)[names(baseline_vars) == 'race_ethnicity'] <- 'race_ethnicity.bl'
names(baseline_vars)[names(baseline_vars) == 'high.educ'] <- 'high.educ.bl'
names(baseline_vars)[names(baseline_vars) == 'neighb_phenx_avg_p'] <- 'neighb_phenx_avg_p.bl'
names(baseline_vars)[names(baseline_vars) == 'overall.income.b'] <- 'overall.income.bl'
names(baseline_vars)[names(baseline_vars) == 'prnt.empl.b'] <- 'prnt.empl.bl'

#add to initial df
HEI_Aim2_Long_2 <- merge(HEI_Aim2_Long, baseline_vars, by="subjectid")
```

## Descriptive Table before Cleaning
```{r}
#factor eventname
HEI_Aim2_Long_2$eventname <- as.factor(HEI_Aim2_Long_2$eventname)
HEI_Aim2_Long_2$eventname <- relevel(HEI_Aim2_Long_2$eventname , ref="Baseline")

#create smaller df
df_prior <- subset(HEI_Aim2_Long_2,select=c("subjectid","abcd_site","eventname","interview_age","reshist_addr1_pm252016aa_bl","prnt.empl.bl","overall.income.bl","sex.bl","race_ethnicity.bl","high.educ.bl","neighb_phenx_avg_p.bl","cbcl_scr_syn_internal_r","cbcl_scr_syn_external_r","cbcl_scr_syn_anxdep_r","cbcl_scr_syn_withdep_r","cbcl_scr_syn_attention_r","cbcl_scr_syn_rulebreak_r","cbcl_scr_syn_aggressive_r","cbcl_scr_syn_totprob_r"))
#create table
des_table_prior <- tableby(eventname ~ ., data = df_prior[ , -which(names(df_prior) %in% c("subjectid"))], total=F) 
summary(des_table_prior, title = "Descriptive Statistics by Eventname Before Cleaning")
```

# Creating variables for modeling and tables

The following variables are time-invariant, will use baseline covariates since PM2.5 collected at baseline:
- reshist_addr1_pm252016aa_bl which is the Baseline PM2.5.
- reshist_addr1_no2_2016_aavg_bl which is the Baseline NO2.
- sex.bl
- race_ethnicity.bl
- high.educ.bl
- prnt.empl.bl 
- neighb_phenx_avg_p.bl
- overall.income.bl 


The following variables are time-varying:
- all CBCL outcomes
- interview_age

## Copy baseline variables to all timepoints for 1KidPerFamily
```{r}
#rename so can use later
names(HEI_Aim2_Long_1KidPerFamily)[names(HEI_Aim2_Long_1KidPerFamily) == 'prnt.empl.bl'] <- 'prnt.empl.b'

#create dataset for table and comparison
baseline_vars_1KidPerFamily <- subset(HEI_Aim2_Long_1KidPerFamily, HEI_Aim2_Long_1KidPerFamily$eventname=="Baseline", select = c("subjectid", "sex", "race_ethnicity", "high.educ", "neighb_phenx_avg_p", "overall.income.b"))

#rename variables
names(baseline_vars_1KidPerFamily)[names(baseline_vars_1KidPerFamily) == 'sex'] <- 'sex.bl'
names(baseline_vars_1KidPerFamily)[names(baseline_vars_1KidPerFamily) == 'race_ethnicity'] <- 'race_ethnicity.bl'
names(baseline_vars_1KidPerFamily)[names(baseline_vars_1KidPerFamily) == 'high.educ'] <- 'high.educ.bl'
names(baseline_vars_1KidPerFamily)[names(baseline_vars_1KidPerFamily) == 'neighb_phenx_avg_p'] <- 'neighb_phenx_avg_p.bl'
names(baseline_vars_1KidPerFamily)[names(baseline_vars_1KidPerFamily) == 'overall.income.b'] <- 'overall.income.bl'
names(baseline_vars_1KidPerFamily)[names(baseline_vars_1KidPerFamily) == 'prnt.empl.b'] <- 'prnt.empl.bl'

#add to initial df
HEI_Aim2_Long_1KidPerFamily_2 <- merge(HEI_Aim2_Long_1KidPerFamily, baseline_vars, by="subjectid")
```

## Clean 1KidPerFamily
```{r}
## Cleaning
#merge Asian into Other group b/c statistically Asian group is too small
tapply(HEI_Aim2_Long_1KidPerFamily_2$race_ethnicity.bl, 
       HEI_Aim2_Long_1KidPerFamily_2$eventname,table, useNA = "always")

HEI_Aim2_Long_1KidPerFamily_2$race_ethnicity.bl <- 
  ifelse(HEI_Aim2_Long_1KidPerFamily_2$race_ethnicity.bl=="Asian","Other",
         HEI_Aim2_Long_1KidPerFamily_2$race_ethnicity.bl)

tapply(HEI_Aim2_Long_1KidPerFamily_2$race_ethnicity.bl, 
       HEI_Aim2_Long_1KidPerFamily_2$eventname,table, useNA = "always")

#reformat variables
HEI_Aim2_Long_1KidPerFamily_2$eventname <- 
  as.factor(HEI_Aim2_Long_1KidPerFamily_2$eventname)

HEI_Aim2_Long_1KidPerFamily_2$eventname <- 
  relevel(HEI_Aim2_Long_1KidPerFamily_2$eventname , ref="Baseline")

table(HEI_Aim2_Long_1KidPerFamily_2$eventname, useNA = "always")


HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_internal_r <- as.numeric(HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_internal_r)
HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_external_r <- as.numeric(HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_external_r)
HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_anxdep_r <- as.numeric(HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_anxdep_r)
HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_withdep_r <- as.numeric(HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_withdep_r)
HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_attention_r <- as.numeric(HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_attention_r)
HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_rulebreak_r <- as.numeric(HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_rulebreak_r)
HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_aggressive_r <- as.numeric(HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_aggressive_r)
HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_totprob_r <- as.numeric(HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_totprob_r)
HEI_Aim2_Long_1KidPerFamily_2$abcd_site <- as.factor(HEI_Aim2_Long_1KidPerFamily_2$abcd_site)
HEI_Aim2_Long_1KidPerFamily_2$subjectid <- as.factor(HEI_Aim2_Long_1KidPerFamily_2$subjectid)
HEI_Aim2_Long_1KidPerFamily_2$prnt.empl.bl <- factor(HEI_Aim2_Long_1KidPerFamily_2$prnt.empl.bl, levels = c("Employed", "Stay at Home Parent", "Unemployed", "Other"))
HEI_Aim2_Long_1KidPerFamily_2$overall.income.bl <- factor(HEI_Aim2_Long_1KidPerFamily_2$overall.income.bl, levels = c("[>=100K]", "[>=50K & <100K]", "[<50k]", "[Don't Know or Refuse]"))
HEI_Aim2_Long_1KidPerFamily_2$sex.bl <- factor(HEI_Aim2_Long_1KidPerFamily_2$sex.bl, levels = c("Male", "Female"))
HEI_Aim2_Long_1KidPerFamily_2$race_ethnicity.bl <- factor(HEI_Aim2_Long_1KidPerFamily_2$race_ethnicity.bl, levels = c("White", "Hispanic", "Black", "Other"))
HEI_Aim2_Long_1KidPerFamily_2$high.educ.bl <- factor(HEI_Aim2_Long_1KidPerFamily_2$high.educ.bl, levels = c("Post Graduate Degree", "Bachelor", "Some College", "HS Diploma/GED", "< HS Diploma"))
```

## Create Final Dataset
```{r results='asis'}
#create smaller df
df <- subset(HEI_Aim2_Long_1KidPerFamily_2,select=c("subjectid","abcd_site","eventname","interview_age","reshist_addr1_pm252016aa_bl","reshist_addr1_no2_2016_aavg_bl","prnt.empl.bl","overall.income.bl","sex.bl","race_ethnicity.bl","high.educ.bl","neighb_phenx_avg_p.bl","cbcl_scr_syn_internal_r","cbcl_scr_syn_external_r","cbcl_scr_syn_anxdep_r","cbcl_scr_syn_withdep_r","cbcl_scr_syn_attention_r","cbcl_scr_syn_rulebreak_r","cbcl_scr_syn_aggressive_r","cbcl_scr_syn_totprob_r"))

#complete cases because needed for zinb
df_cc <- df[complete.cases(df),]

#percentage of subjects lost with complete.cases
lost_sub <- data.frame(table(df$eventname))
colnames(lost_sub) <- c("eventname","abcd")
interim <- data.frame(table(df_cc$eventname))[2]
lost_sub$sample <- interim$Freq
lost_sub$diff <- lost_sub$abcd - lost_sub$sample
lost_sub$percent <- lost_sub$diff/lost_sub$abcd

#center age at 9years-old (i.e., 108 months)
df_cc$interview_age.c9 <- df_cc$interview_age-108
#change to years
df_cc$interview_age.c9.y <- df_cc$interview_age.c9/12
#center pm2.5 to 5 (recommended by WHO)
df_cc$reshist_addr1_pm252016aa_bl.c5 <- df_cc$reshist_addr1_pm252016aa_bl-5
#center no2 to 5.33 (recommended by WHO)
df_cc$reshist_addr1_no2_2016_aavg_bl.c533 <- df_cc$reshist_addr1_no2_2016_aavg_bl-5.33

#center around mean
neighb_phenx_avg_p.bl.cm <- df_cc$neighb_phenx_avg_p.bl - mean(df_cc$neighb_phenx_avg_p.bl)

#create table
des_table <- tableby(eventname ~ ., data = df_cc[ , -which(names(df_cc) %in% c("subjectid"))], total=F) 
summary(des_table, title = "Descriptive Statistics by Eventname After Cleaning")

Final_DF_Descriptives <- summary(des_table, title = "Descriptive Statistics by Eventname After Cleaning")
#write.csv(Final_DF_Descriptives, "Descriptives_Final_Dataset.csv")
```

## Create Comparison b/t Full and Final Datasets
```{r results='asis'}
# Using the following two CBCL data as full and final analytic sample
Full_Data <- 
  df_prior[,c("subjectid","abcd_site","eventname","interview_age","prnt.empl.bl","overall.income.bl","sex.bl","race_ethnicity.bl","high.educ.bl","neighb_phenx_avg_p.bl")]

Analysis_Data <- 
  df_cc[,c("subjectid","abcd_site","eventname","interview_age","prnt.empl.bl","overall.income.bl","sex.bl","race_ethnicity.bl","high.educ.bl","neighb_phenx_avg_p.bl")]

str(Full_Data)
str(Analysis_Data)

Full_Data$label = "Full_data"
Analysis_Data$label = "Analysis_data"

# Merging the two data set to be used in arsenal package

CBCL_Combined_Data <- rbind(Full_Data, Analysis_Data)
names(CBCL_Combined_Data)
dim(CBCL_Combined_Data)
dim(Full_Data)[1] + dim(Analysis_Data)[1]

# Baseline comparison--------------------------------------------------------
Combined_Data_rbl_Baseline <-  
  tableby(label ~ sex.bl + interview_age +
  race_ethnicity.bl + high.educ.bl + prnt.empl.bl + neighb_phenx_avg_p.bl +
  overall.income.bl, 
  subset= (eventname=="Baseline"),
  data = CBCL_Combined_Data, total=F)

Combined_Data_Compare_Baseline <- summary(Combined_Data_rbl_Baseline)
Combined_Data_Compare_Baseline
#write.csv(Combined_Data_Compare_Baseline, "Combined_Data_Compare_Baseline.csv")

## Sanity check to see above p-value matches regular chi-squared in R and it does!
chisq.test(CBCL_Combined_Data[which(CBCL_Combined_Data$eventname=="Baseline"),]$label, 
           CBCL_Combined_Data[which(CBCL_Combined_Data$eventname=="Baseline"),]$sex.bl,
           correct = FALSE)

chisq.test(CBCL_Combined_Data[which(CBCL_Combined_Data$eventname=="Baseline"),]$label, 
           CBCL_Combined_Data[which(CBCL_Combined_Data$eventname=="Baseline"),]$race_ethnicity.bl,
           correct = FALSE)

chisq.test(CBCL_Combined_Data[which(CBCL_Combined_Data$eventname=="Baseline"),]$label, 
           CBCL_Combined_Data[which(CBCL_Combined_Data$eventname=="Baseline"),]$high.educ.bl,
           correct = FALSE)

summary(aov(interview_age ~ label,
    data=CBCL_Combined_Data[which(CBCL_Combined_Data$eventname=="Baseline"),]))
#---------------------------------------------------------------------------------------
# One Year Comparison
Combined_Data_rbl_OneYear <-  
  tableby(label ~ sex.bl + interview_age +
  race_ethnicity.bl + high.educ.bl + prnt.empl.bl + neighb_phenx_avg_p.bl +
  overall.income.bl, 
  subset= (eventname=="1-year"),
  data = CBCL_Combined_Data, total=F)

Combined_Data_Compare_OneYear <- summary(Combined_Data_rbl_OneYear)
Combined_Data_Compare_OneYear
#write.csv(Combined_Data_Compare_OneYear,  "Combined_Data_Compare_OneYear.csv")

#---------------------------------------------------------------------------------------
# Two Year Comparison
Combined_Data_rbl_TwoYear <-  
  tableby(label ~ sex.bl + interview_age +
  race_ethnicity.bl + high.educ.bl + prnt.empl.bl + neighb_phenx_avg_p.bl +
  overall.income.bl, 
  subset= (eventname=="2-year"),
  data = CBCL_Combined_Data, total=F)

Combined_Data_Compare_TwoYear <- summary(Combined_Data_rbl_TwoYear)
Combined_Data_Compare_TwoYear
#write.csv(Combined_Data_Compare_TwoYear,  "Combined_Data_Compare_TwoYear.csv")
```

# Code to Check Skewness
```{r}
## Notes on how to check skewness
# If skewness is less than -1 or greater than 1, the distribution is highly skewed.
# If the kurtosis is greater than 3, then the data set has heavier tails than a normal
# distribution (more in the tails).  If the kurtosis is less than 3, then the 
# has lighter tails than a normal distribution (less in the tails). 
skew(df_cc$cbcl_scr_syn_internal_r)
kurtosis(df_cc$cbcl_scr_syn_internal_r)
```

# Distribution of outcome variables by eventname
```{r}
ggplot(df_cc,aes(cbcl_scr_syn_internal_r)) + geom_histogram(binwidth = 1) + facet_grid(.~eventname)
ggplot(df_cc,aes(cbcl_scr_syn_external_r)) + geom_histogram(binwidth = 1) + facet_grid(.~eventname)
ggplot(df_cc,aes(cbcl_scr_syn_anxdep_r)) + geom_histogram(binwidth = 1) + facet_grid(.~eventname)
ggplot(df_cc,aes(cbcl_scr_syn_withdep_r)) + geom_histogram(binwidth = 1) + facet_grid(.~eventname)
ggplot(df_cc,aes(cbcl_scr_syn_attention_r)) + geom_histogram(binwidth = 1) + facet_grid(.~eventname)
ggplot(df_cc,aes(cbcl_scr_syn_rulebreak_r)) + geom_histogram(binwidth = 1) + facet_grid(.~eventname)
ggplot(df_cc,aes(cbcl_scr_syn_aggressive_r)) + geom_histogram(binwidth = 1) + facet_grid(.~eventname)
ggplot(df_cc,aes(cbcl_scr_syn_totprob_r)) + geom_histogram(binwidth = 1) + facet_grid(.~eventname)
```

# Check overdispersion for each outcome
```{r}
#check variance/mean ratio for overdispersion (greater than 1)
var(df_cc$cbcl_scr_syn_internal_r) %>% round(4)/mean(df_cc$cbcl_scr_syn_internal_r) %>% round(4)
var(df_cc$cbcl_scr_syn_external_r) %>% round(4)/mean(df_cc$cbcl_scr_syn_external_r) %>% round(4)
var(df_cc$cbcl_scr_syn_anxdep_r) %>% round(4)/mean(df_cc$cbcl_scr_syn_anxdep_r) %>% round(4)
var(df_cc$cbcl_scr_syn_withdep_r) %>% round(4)/mean(df_cc$cbcl_scr_syn_withdep_r) %>% round(4)
var(df_cc$cbcl_scr_syn_attention_r) %>% round(4)/mean(df_cc$cbcl_scr_syn_attention_r) %>% round(4)
var(df_cc$cbcl_scr_syn_rulebreak_r) %>% round(4)/mean(df_cc$cbcl_scr_syn_rulebreak_r) %>% round(4)
var(df_cc$cbcl_scr_syn_aggressive_r) %>% round(4)/mean(df_cc$cbcl_scr_syn_aggressive_r) %>% round(4)
var(df_cc$cbcl_scr_syn_totprob_r) %>% round(4)/mean(df_cc$cbcl_scr_syn_totprob_r) %>% round(4)
```

# Percentage of 0's for each CBCL Outcome
```{r}
zeros <- df_cc %>% 
  group_by(eventname) %>% 
  dplyr::select(starts_with(c("eventname","cbcl"))) %>% 
  summarise_each(funs(sum(.==0)))

all <- df_cc %>% 
  group_by(eventname) %>% 
  dplyr::select(starts_with(c("eventname","cbcl"))) %>% 
  summarise_each(funs(n()))

zero_percentage <- cbind(zeros[1],round(zeros[-1]/all[-1],4)*100)

zero_percentage
```

# Percentage of 0's for all timepoints for each CBCL Outcome
```{r}
#select certain columns
subject_sum <- df_cc %>% 
  dplyr::select(starts_with(c("subject","cbcl")))
#add up all scores across subjec
subject_summed <- ddply(subject_sum, "subjectid", numcolwise(sum))
#look at data
describe(subject_summed[,2:9])

#percentage of subjects who have zero across all timepoints
all_zeros <- as.data.frame(colSums(subject_summed == 0))
all_zeros$percentage_allzero <- all_zeros$`colSums(subject_summed == 0)`/nrow(subject_summed)
all_zeros$percentage_allzero <- round(all_zeros$percentage_allzero,4)*100
percentage_allzero <- all_zeros$percentage_allzero


#distribution
ggplot(subject_summed,aes(cbcl_scr_syn_internal_r)) + geom_histogram(binwidth = 1)
ggplot(subject_summed,aes(cbcl_scr_syn_external_r)) + geom_histogram(binwidth = 1)
ggplot(subject_summed,aes(cbcl_scr_syn_anxdep_r)) + geom_histogram(binwidth = 1)
ggplot(subject_summed,aes(cbcl_scr_syn_withdep_r)) + geom_histogram(binwidth = 1)
ggplot(subject_summed,aes(cbcl_scr_syn_attention_r)) + geom_histogram(binwidth = 1)
ggplot(subject_summed,aes(cbcl_scr_syn_rulebreak_r)) + geom_histogram(binwidth = 1)
ggplot(subject_summed,aes(cbcl_scr_syn_aggressive_r)) + geom_histogram(binwidth = 1)
ggplot(subject_summed,aes(cbcl_scr_syn_totprob_r)) + geom_histogram(binwidth = 1)
```

#Percentage of average people who have 0 at baseline and have 0 the whole time
```{r}
zero_comparison <- rbind(zero_percentage, percentage_allzero)
zero_comparison$eventname <- as.character(zero_comparison$eventname)
zero_comparison[4,1] <- "All"
zero_comparison <- t(zero_comparison)
colnames(zero_comparison) <- c("Baseline","1-year","2-year","All")
zero_comparison <- as.data.frame(zero_comparison[2:9,])
zero_comparison <- lapply(zero_comparison,as.numeric)
zero_comparison$zeros_of_bl <- zero_comparison$All/zero_comparison$Baseline
zero_comparison$CBCL_Outcome <- c("cbcl_scr_syn_internal_r","cbcl_scr_syn_external_r","cbcl_scr_syn_anxdep_r","cbcl_scr_syn_withdep_r","cbcl_scr_syn_attention_r","cbcl_scr_syn_rulebreak_r","cbcl_scr_syn_aggressive_r","cbcl_scr_syn_totprob_r")
```

# ICC's for total sample and subjects with CBCL = 0
```{r}
# Necessary libraries
# For lmer()
suppressPackageStartupMessages(library(lme4))
# For ICC
suppressPackageStartupMessages(library(performance))
# For repeatability estimate (rICC)
suppressPackageStartupMessages(library(rptR))

#internal
## all datapts
internal_icc_model <-lmer(cbcl_scr_syn_internal_r ~ 1 + (1 | subjectid),
              data = df_cc,
              REML = TRUE)
summary(internal_icc_model)
icc(internal_icc_model)
## zeros
internal_zero_ids_df <- df_cc %>% dplyr::select(c("subjectid","cbcl_scr_syn_internal_r")) %>% filter(cbcl_scr_syn_internal_r==0)
internal_zero_ids <- unique(internal_zero_ids_df$subjectid)
internal_zero <- df_cc %>% dplyr::select(c("subjectid","cbcl_scr_syn_internal_r")) %>% filter(subjectid %in% internal_zero_ids)
internal_icc_model_zeros <-lmer(cbcl_scr_syn_internal_r ~ 1 + (1 | subjectid),
              data = internal_zero,
              REML = TRUE)
summary(internal_icc_model_zeros)
icc(internal_icc_model_zeros)

#external
## all datapts
external_icc_model <-lmer(cbcl_scr_syn_external_r ~ 1 + (1 | subjectid),
              data = df_cc,
              REML = TRUE)
summary(external_icc_model)
icc(external_icc_model)
## zeros
external_zero_ids_df <- df_cc %>% dplyr::select(c("subjectid","cbcl_scr_syn_external_r")) %>% filter(cbcl_scr_syn_external_r==0)
external_zero_ids <- unique(external_zero_ids_df$subjectid)
external_zero <- df_cc %>% dplyr::select(c("subjectid","cbcl_scr_syn_external_r")) %>% filter(subjectid %in% external_zero_ids)
external_icc_model_zeros <-lmer(cbcl_scr_syn_external_r ~ 1 + (1 | subjectid),
              data = external_zero,
              REML = TRUE)
summary(external_icc_model_zeros)
icc(external_icc_model_zeros)

#anxdep
## all datapts
anxdep_icc_model <-lmer(cbcl_scr_syn_anxdep_r ~ 1 + (1 | subjectid),
              data = df_cc,
              REML = TRUE)
summary(anxdep_icc_model)
icc(anxdep_icc_model)
## zeros
anxdep_zero_ids_df <- df_cc %>% dplyr::select(c("subjectid","cbcl_scr_syn_anxdep_r")) %>% filter(cbcl_scr_syn_anxdep_r==0)
anxdep_zero_ids <- unique(anxdep_zero_ids_df$subjectid)
anxdep_zero <- df_cc %>% dplyr::select(c("subjectid","cbcl_scr_syn_anxdep_r")) %>% filter(subjectid %in% anxdep_zero_ids)
anxdep_icc_model_zeros <-lmer(cbcl_scr_syn_anxdep_r ~ 1 + (1 | subjectid),
              data = anxdep_zero,
              REML = TRUE)
summary(anxdep_icc_model_zeros)
icc(anxdep_icc_model_zeros)

#withdep
## all datapts
withdep_icc_model <-lmer(cbcl_scr_syn_withdep_r ~ 1 + (1 | subjectid),
              data = df_cc,
              REML = TRUE)
summary(withdep_icc_model)
icc(withdep_icc_model)
## zeros
withdep_zero_ids_df <- df_cc %>% dplyr::select(c("subjectid","cbcl_scr_syn_withdep_r")) %>% filter(cbcl_scr_syn_withdep_r==0)
withdep_zero_ids <- unique(withdep_zero_ids_df$subjectid)
withdep_zero <- df_cc %>% dplyr::select(c("subjectid","cbcl_scr_syn_withdep_r")) %>% filter(subjectid %in% withdep_zero_ids)
withdep_icc_model_zeros <-lmer(cbcl_scr_syn_withdep_r ~ 1 + (1 | subjectid),
              data = withdep_zero,
              REML = TRUE)
summary(withdep_icc_model_zeros)
icc(withdep_icc_model_zeros)

#attention
## all datapts
attention_icc_model <-lmer(cbcl_scr_syn_attention_r ~ 1 + (1 | subjectid),
              data = df_cc,
              REML = TRUE)
summary(attention_icc_model)
icc(attention_icc_model)
## zeros
attention_zero_ids_df <- df_cc %>% dplyr::select(c("subjectid","cbcl_scr_syn_attention_r")) %>% filter(cbcl_scr_syn_attention_r==0)
attention_zero_ids <- unique(attention_zero_ids_df$subjectid)
attention_zero <- df_cc %>% dplyr::select(c("subjectid","cbcl_scr_syn_attention_r")) %>% filter(subjectid %in% attention_zero_ids)
attention_icc_model_zeros <-lmer(cbcl_scr_syn_attention_r ~ 1 + (1 | subjectid),
              data = attention_zero,
              REML = TRUE)
summary(attention_icc_model_zeros)
icc(attention_icc_model_zeros)

#rulebreak
## all datapts
rulebreak_icc_model <-lmer(cbcl_scr_syn_rulebreak_r ~ 1 + (1 | subjectid),
              data = df_cc,
              REML = TRUE)
summary(rulebreak_icc_model)
icc(rulebreak_icc_model)
## zeros
rulebreak_zero_ids_df <- df_cc %>% dplyr::select(c("subjectid","cbcl_scr_syn_rulebreak_r")) %>% filter(cbcl_scr_syn_rulebreak_r==0)
rulebreak_zero_ids <- unique(rulebreak_zero_ids_df$subjectid)
rulebreak_zero <- df_cc %>% dplyr::select(c("subjectid","cbcl_scr_syn_rulebreak_r")) %>% filter(subjectid %in% rulebreak_zero_ids)
rulebreak_icc_model_zeros <-lmer(cbcl_scr_syn_rulebreak_r ~ 1 + (1 | subjectid),
              data = rulebreak_zero,
              REML = TRUE)
summary(rulebreak_icc_model_zeros)
icc(rulebreak_icc_model_zeros)

#aggressive
## all datapts
aggressive_icc_model <-lmer(cbcl_scr_syn_aggressive_r ~ 1 + (1 | subjectid),
              data = df_cc,
              REML = TRUE)
summary(aggressive_icc_model)
icc(aggressive_icc_model)
## zeros
aggressive_zero_ids_df <- df_cc %>% dplyr::select(c("subjectid","cbcl_scr_syn_aggressive_r")) %>% filter(cbcl_scr_syn_aggressive_r==0)
aggressive_zero_ids <- unique(aggressive_zero_ids_df$subjectid)
aggressive_zero <- df_cc %>% dplyr::select(c("subjectid","cbcl_scr_syn_aggressive_r")) %>% filter(subjectid %in% aggressive_zero_ids)
aggressive_icc_model_zeros <-lmer(cbcl_scr_syn_aggressive_r ~ 1 + (1 | subjectid),
              data = aggressive_zero,
              REML = TRUE)
summary(aggressive_icc_model_zeros)
icc(aggressive_icc_model_zeros)
```

# ICC's for subjects with CBCL > 0
```{r}
# Necessary libraries
# For lmer()
suppressPackageStartupMessages(library(lme4))
# For ICC
suppressPackageStartupMessages(library(performance))
# For repeatability estimate (rICC)
suppressPackageStartupMessages(library(rptR))

#internal
## nonzeros
internal_nonzero_ids_df <- df_cc %>% dplyr::select(c("subjectid","cbcl_scr_syn_internal_r")) %>% filter(cbcl_scr_syn_internal_r>0)
internal_nonzero_ids <- unique(internal_nonzero_ids_df$subjectid)
internal_nonzero <- df_cc %>% dplyr::select(c("subjectid","cbcl_scr_syn_internal_r")) %>% filter(subjectid %in% internal_nonzero_ids)
internal_icc_model_nonzeros <-lmer(cbcl_scr_syn_internal_r ~ 1 + (1 | subjectid),
              data = internal_nonzero,
              REML = TRUE)
summary(internal_icc_model_nonzeros)
icc(internal_icc_model_nonzeros)

#external
## nonzeros
external_nonzero_ids_df <- df_cc %>% dplyr::select(c("subjectid","cbcl_scr_syn_external_r")) %>% filter(cbcl_scr_syn_external_r>0)
external_nonzero_ids <- unique(external_nonzero_ids_df$subjectid)
external_nonzero <- df_cc %>% dplyr::select(c("subjectid","cbcl_scr_syn_external_r")) %>% filter(subjectid %in% external_nonzero_ids)
external_icc_model_nonzeros <-lmer(cbcl_scr_syn_external_r ~ 1 + (1 | subjectid),
              data = external_nonzero,
              REML = TRUE)
summary(external_icc_model_nonzeros)
icc(external_icc_model_nonzeros)

#anxdep
## nonzeros
anxdep_nonzero_ids_df <- df_cc %>% dplyr::select(c("subjectid","cbcl_scr_syn_anxdep_r")) %>% filter(cbcl_scr_syn_anxdep_r>0)
anxdep_nonzero_ids <- unique(anxdep_nonzero_ids_df$subjectid)
anxdep_nonzero <- df_cc %>% dplyr::select(c("subjectid","cbcl_scr_syn_anxdep_r")) %>% filter(subjectid %in% anxdep_nonzero_ids)
anxdep_icc_model_nonzeros <-lmer(cbcl_scr_syn_anxdep_r ~ 1 + (1 | subjectid),
              data = anxdep_nonzero,
              REML = TRUE)
summary(anxdep_icc_model_nonzeros)
icc(anxdep_icc_model_nonzeros)

#withdep
## nonzeros
withdep_nonzero_ids_df <- df_cc %>% dplyr::select(c("subjectid","cbcl_scr_syn_withdep_r")) %>% filter(cbcl_scr_syn_withdep_r>0)
withdep_nonzero_ids <- unique(withdep_nonzero_ids_df$subjectid)
withdep_nonzero <- df_cc %>% dplyr::select(c("subjectid","cbcl_scr_syn_withdep_r")) %>% filter(subjectid %in% withdep_nonzero_ids)
withdep_icc_model_nonzeros <-lmer(cbcl_scr_syn_withdep_r ~ 1 + (1 | subjectid),
              data = withdep_nonzero,
              REML = TRUE)
summary(withdep_icc_model_nonzeros)
icc(withdep_icc_model_nonzeros)

#attention
## nonzeros
attention_nonzero_ids_df <- df_cc %>% dplyr::select(c("subjectid","cbcl_scr_syn_attention_r")) %>% filter(cbcl_scr_syn_attention_r>0)
attention_nonzero_ids <- unique(attention_nonzero_ids_df$subjectid)
attention_nonzero <- df_cc %>% dplyr::select(c("subjectid","cbcl_scr_syn_attention_r")) %>% filter(subjectid %in% attention_nonzero_ids)
attention_icc_model_nonzeros <-lmer(cbcl_scr_syn_attention_r ~ 1 + (1 | subjectid),
              data = attention_nonzero,
              REML = TRUE)
summary(attention_icc_model_nonzeros)
icc(attention_icc_model_nonzeros)

#rulebreak
## nonzeros
rulebreak_nonzero_ids_df <- df_cc %>% dplyr::select(c("subjectid","cbcl_scr_syn_rulebreak_r")) %>% filter(cbcl_scr_syn_rulebreak_r>0)
rulebreak_nonzero_ids <- unique(rulebreak_nonzero_ids_df$subjectid)
rulebreak_nonzero <- df_cc %>% dplyr::select(c("subjectid","cbcl_scr_syn_rulebreak_r")) %>% filter(subjectid %in% rulebreak_nonzero_ids)
rulebreak_icc_model_nonzeros <-lmer(cbcl_scr_syn_rulebreak_r ~ 1 + (1 | subjectid),
              data = rulebreak_nonzero,
              REML = TRUE)
summary(rulebreak_icc_model_nonzeros)
icc(rulebreak_icc_model_nonzeros)

#aggressive
## nonzeros
aggressive_nonzero_ids_df <- df_cc %>% dplyr::select(c("subjectid","cbcl_scr_syn_aggressive_r")) %>% filter(cbcl_scr_syn_aggressive_r>0)
aggressive_nonzero_ids <- unique(aggressive_nonzero_ids_df$subjectid)
aggressive_nonzero <- df_cc %>% dplyr::select(c("subjectid","cbcl_scr_syn_aggressive_r")) %>% filter(subjectid %in% aggressive_nonzero_ids)
aggressive_icc_model_nonzeros <-lmer(cbcl_scr_syn_aggressive_r ~ 1 + (1 | subjectid),
              data = aggressive_nonzero,
              REML = TRUE)
summary(aggressive_icc_model_nonzeros)
icc(aggressive_icc_model_nonzeros)
```

# Air Pollution Descriptives
```{r}
#pm2.5
mean(df_cc$reshist_addr1_pm252016aa_bl[df_cc$eventname=="Baseline"])
sd(df_cc$reshist_addr1_pm252016aa_bl[df_cc$eventname=="Baseline"])
range(df_cc$reshist_addr1_pm252016aa_bl[df_cc$eventname=="Baseline"])
hist(df_cc$reshist_addr1_pm252016aa_bl[df_cc$eventname=="Baseline"])
##test difference with EPA level
t.test(df_cc$reshist_addr1_pm252016aa_bl[df_cc$eventname=="Baseline"], mu = 12, alternative = "two.sided")
#no2
mean(df_cc$reshist_addr1_no2_2016_aavg_bl[df_cc$eventname=="Baseline"])
sd(df_cc$reshist_addr1_no2_2016_aavg_bl[df_cc$eventname=="Baseline"])
range(df_cc$reshist_addr1_no2_2016_aavg_bl[df_cc$eventname=="Baseline"])
hist(df_cc$reshist_addr1_no2_2016_aavg_bl[df_cc$eventname=="Baseline"])
##test difference with EPA level
t.test(df_cc$reshist_addr1_no2_2016_aavg_bl[df_cc$eventname=="Baseline"], mu = 53, alternative = "two.sided")
```

# Histogram of CBCL Outcomes by Wave
```{r}
internal_histogram <- ggplot(df_cc, aes(x=cbcl_scr_syn_internal_r)) + geom_histogram() + facet_grid(~eventname) + labs(x="Internalizing Behavior") +
  theme(axis.title.x = element_text(face="bold"))
external_histogram <- ggplot(df_cc, aes(x=cbcl_scr_syn_external_r)) + geom_histogram() + facet_grid(~eventname) + labs(x="Externalizing Behavior") +
  theme(axis.title.x = element_text(face="bold"))
anxdep_histogram <- ggplot(df_cc, aes(x=cbcl_scr_syn_anxdep_r)) + geom_histogram() + facet_grid(~eventname) + labs(x="Anxious/Depressed") +
  theme(axis.title.x = element_text(face="bold"))
withdep_histogram <- ggplot(df_cc, aes(x=cbcl_scr_syn_withdep_r)) + geom_histogram() + facet_grid(~eventname) + labs(x="Withdrawn/Depressed") +
  theme(axis.title.x = element_text(face="bold"))
attention_histogram <- ggplot(df_cc, aes(x=cbcl_scr_syn_attention_r)) + geom_histogram() + facet_grid(~eventname) + labs(x="Attention Problems") +
  theme(axis.title.x = element_text(face="bold"))
rulebreak_histogram <- ggplot(df_cc, aes(x=cbcl_scr_syn_rulebreak_r)) + geom_histogram() + facet_grid(~eventname) + labs(x="Rule-breaking Behavior") +
  theme(axis.title.x = element_text(face="bold")) 
aggressive_histogram <- ggplot(df_cc, aes(x=cbcl_scr_syn_aggressive_r)) + geom_histogram() + facet_grid(~eventname) + labs(x="Aggressive Behavior") +
  theme(axis.title.x = element_text(face="bold")) 

#export above
##arrange plots
histograms <- grid.arrange(internal_histogram, anxdep_histogram, withdep_histogram, external_histogram, rulebreak_histogram, aggressive_histogram, attention_histogram, ncol=3) 
##save
#ggsave(histograms,device="png",filename="Figures/CBCL_Histograms_2.7.23.png",width=12,height=12, units = "in")
```

# Check linearity of non-zero cbcl scores with air pollution estimates
## PM2.5
```{r}
#internal
internal_linear <- df_cc %>% dplyr::select(c("subjectid","eventname","cbcl_scr_syn_internal_r","reshist_addr1_pm252016aa_bl","reshist_addr1_no2_2016_aavg_bl")) %>% filter(cbcl_scr_syn_internal_r>0)
internal_linear_pm <- ggplot(internal_linear,aes(x=cbcl_scr_syn_internal_r,y=reshist_addr1_pm252016aa_bl)) + geom_point() + geom_smooth() + facet_grid(~eventname) + labs(x="internal",y="pm2.5")
internal_linear_no <- ggplot(internal_linear,aes(x=cbcl_scr_syn_internal_r,y=reshist_addr1_no2_2016_aavg_bl)) + geom_point() + geom_smooth() + facet_grid(~eventname) + labs(x="internal",y="no2")

#anxdep
anxdep_linear <- df_cc %>% dplyr::select(c("subjectid","eventname","cbcl_scr_syn_anxdep_r","reshist_addr1_pm252016aa_bl","reshist_addr1_no2_2016_aavg_bl")) %>% filter(cbcl_scr_syn_anxdep_r>0)
anxdep_linear_pm <- ggplot(anxdep_linear,aes(x=cbcl_scr_syn_anxdep_r,y=reshist_addr1_pm252016aa_bl)) + geom_point() + geom_smooth() + facet_grid(~eventname) + labs(x="anxdep",y="pm2.5")
anxdep_linear_no <- ggplot(anxdep_linear,aes(x=cbcl_scr_syn_anxdep_r,y=reshist_addr1_no2_2016_aavg_bl)) + geom_point() + geom_smooth() + facet_grid(~eventname) + labs(x="anxdep",y="no2")

#withdep
withdep_linear <- df_cc %>% dplyr::select(c("subjectid","eventname","cbcl_scr_syn_withdep_r","reshist_addr1_pm252016aa_bl","reshist_addr1_no2_2016_aavg_bl")) %>% filter(cbcl_scr_syn_withdep_r>0)
withdep_linear_pm <- ggplot(withdep_linear,aes(x=cbcl_scr_syn_withdep_r,y=reshist_addr1_pm252016aa_bl)) + geom_point() + geom_smooth() + facet_grid(~eventname) + labs(x="withdep",y="pm2.5")
withdep_linear_no <- ggplot(withdep_linear,aes(x=cbcl_scr_syn_withdep_r,y=reshist_addr1_no2_2016_aavg_bl)) + geom_point() + geom_smooth() + facet_grid(~eventname) + labs(x="withdep",y="no2")

#external
external_linear <- df_cc %>% dplyr::select(c("subjectid","eventname","cbcl_scr_syn_external_r","reshist_addr1_pm252016aa_bl","reshist_addr1_no2_2016_aavg_bl")) %>% filter(cbcl_scr_syn_external_r>0)
external_linear_pm <- ggplot(external_linear,aes(x=cbcl_scr_syn_external_r,y=reshist_addr1_pm252016aa_bl)) + geom_point() + geom_smooth() + facet_grid(~eventname) + labs(x="external",y="pm2.5")
external_linear_no <- ggplot(external_linear,aes(x=cbcl_scr_syn_external_r,y=reshist_addr1_no2_2016_aavg_bl)) + geom_point() + geom_smooth() + facet_grid(~eventname) + labs(x="external",y="no2")

#rulebreak
rulebreak_linear <- df_cc %>% dplyr::select(c("subjectid","eventname","cbcl_scr_syn_rulebreak_r","reshist_addr1_pm252016aa_bl","reshist_addr1_no2_2016_aavg_bl")) %>% filter(cbcl_scr_syn_rulebreak_r>0)
rulebreak_linear_pm <- ggplot(rulebreak_linear,aes(x=cbcl_scr_syn_rulebreak_r,y=reshist_addr1_pm252016aa_bl)) + geom_point() + geom_smooth() + facet_grid(~eventname) + labs(x="rulebreak",y="pm2.5")
rulebreak_linear_no <- ggplot(rulebreak_linear,aes(x=cbcl_scr_syn_rulebreak_r,y=reshist_addr1_no2_2016_aavg_bl)) + geom_point() + geom_smooth() + facet_grid(~eventname) + labs(x="rulebreak",y="no2")

#aggressive
aggressive_linear <- df_cc %>% dplyr::select(c("subjectid","eventname","cbcl_scr_syn_aggressive_r","reshist_addr1_pm252016aa_bl","reshist_addr1_no2_2016_aavg_bl")) %>% filter(cbcl_scr_syn_aggressive_r>0)
aggressive_linear_pm <- ggplot(aggressive_linear,aes(x=cbcl_scr_syn_aggressive_r,y=reshist_addr1_pm252016aa_bl)) + geom_point() + geom_smooth() + facet_grid(~eventname) + labs(x="aggressive",y="pm2.5")
aggressive_linear_no <- ggplot(aggressive_linear,aes(x=cbcl_scr_syn_aggressive_r,y=reshist_addr1_no2_2016_aavg_bl)) + geom_point() + geom_smooth() + facet_grid(~eventname) + labs(x="aggressive",y="no2")

#attention
attention_linear <- df_cc %>% dplyr::select(c("subjectid","eventname","cbcl_scr_syn_attention_r","reshist_addr1_pm252016aa_bl","reshist_addr1_no2_2016_aavg_bl")) %>% filter(cbcl_scr_syn_attention_r>0)
attention_linear_pm <- ggplot(attention_linear,aes(x=cbcl_scr_syn_attention_r,y=reshist_addr1_pm252016aa_bl)) + geom_point() + geom_smooth() + facet_grid(~eventname) + labs(x="attention",y="pm2.5")
attention_linear_no <- ggplot(attention_linear,aes(x=cbcl_scr_syn_attention_r,y=reshist_addr1_no2_2016_aavg_bl)) + geom_point() + geom_smooth() + facet_grid(~eventname) + labs(x="attention",y="no2")

#all graphs
linearity_pm <- grid.arrange(internal_linear_pm, anxdep_linear_pm, withdep_linear_pm, external_linear_pm, rulebreak_linear_pm, aggressive_linear_pm, attention_linear_pm, ncol=1) 
linearity_no <- grid.arrange(internal_linear_no, anxdep_linear_no, withdep_linear_no, external_linear_no, rulebreak_linear_no, aggressive_linear_no, attention_linear_no, ncol=1) 
##save
#ggsave(linearity_pm,device="png",filename="Figures/CBCL.PM2p5_Linearity_6.3.23.png",width=12,height=12, units = "in")
#ggsave(linearity_no,device="png",filename="Figures/CBCL.NO2_Linearity_6.3.23.png",width=12,height=12, units = "in")
```




# Internalizing

## CBCL + AP Longitudinal Models
Zero-Inflated (ZI) Negative Binomial (NB): glmm.zinb in NBZIMM package.

CBCL only needs one nested random intercept since we eliminated the family nesting
by choosing one kid per family.

For the negative binomial portion of the model, we do not nest by subject since the ICC across subjects is very low.

```{r}
internal_zinb_r <- glmm.zinb(cbcl_scr_syn_internal_r ~ interview_age.c9.y + race_ethnicity.bl + high.educ.bl+ prnt.empl.bl  + neighb_phenx_avg_p.bl.cm + overall.income.bl + sex.bl, random = ~1|abcd_site/subjectid,
              zi_fixed = ~ interview_age.c9.y + race_ethnicity.bl + high.educ.bl+ prnt.empl.bl  + neighb_phenx_avg_p.bl.cm + overall.income.bl + sex.bl, zi_random = ~1|abcd_site, data = df_cc)

summary(internal_zinb_r)
summary(internal_zinb_r$zi.fit)
anova(internal_zinb_r)
VarCorr(internal_zinb_r)
```

## Assumption checking for ZINB Models

- Zero inflated negative binomial (zinb) regression already has overdispersion and excess zeros
and this is accounted for in the zinb modeling chosen, "The data distribution combines the 
negative binomial distribution and the logit distribution"

- Details on zinb can be found here: 
[link](https://ncss-wpengine.netdna-ssl.com/wp-content/themes/ncss/pdf/Procedures/NCSS/Zero-Inflated_Negative_Binomial_Regression.pdf)

For Model Checking we will follow the following pdf:
[link](https://www.ncss.com/wp-content/themes/ncss/pdf/Procedures/NCSS/Zero-Inflated_Negative_Binomial_Regression.pdf)
This info is further detailed/published in books by Cameron and Trivedi (2013) and Hilbe (2014) and in Garay, Hashimoto, Ortega, and Lachos (2011).

They suggest using Pearson residuals.

```{r}
#Check outlier/residuals with this df
internal_res <- df_cc
internal_res$level1_resid.raw <- residuals(internal_zinb_r)
internal_res$level1_resid.pearson <- residuals(internal_zinb_r, type="pearson")
#Add predicted values (Yhat)
internal_res$cbcl_scr_syn_internal_r_predicted <- predict(internal_zinb_r,internal_res,type="response")
#Incidence
internal_res$incidence <- estimate.probability(internal_res$cbcl_scr_syn_internal_r, method="empirical")

#Plotting histogram of residuals, but may be skewed since using ZINB, so make sure to check below plots
hist(internal_res$level1_resid.pearson)
```

### Incidence vs. X's Plots
"These plots show each of the independent variables plotted against the incidence as measured by Y (CBCL Outcome). They
should be scanned for outliers and curvilinear patterns."
```{r}
#age
ggplot(internal_res,aes(incidence,interview_age)) + geom_point(color = "black") + geom_smooth(method = "loess")
```

### Residuals vs Y (CBCL Outcome) Plot
"This plot shows the residuals versus the dependent variable. It can be used to spot outliers."
```{r}
plot(internal_res$level1_resid.pearson, internal_res$cbcl_scr_syn_internal_r)
```

### Residuals vs Yhat Plot
"This plot shows the residuals versus the predicted value (Yhat) of the dependent variable. It can show outliers."
```{r}
plot(internal_res$level1_resid.pearson, internal_res$cbcl_scr_syn_internal_r_predicted)
```

### Residuals vs Row Plot
"This plot shows the residuals versus the row numbers. It is used to quickly spot rows that have large residuals."
```{r}
plot(as.numeric(rownames(internal_res)),internal_res$level1_resid.pearson)
```

### Residuals vs X's Plots
"These plots show the residuals plotted against the independent variables. They are used to spot outliers. They are
also used to find curvilinear patterns that are not represented in the regression model."
```{r}
#age
ggplot(internal_res,aes(level1_resid.pearson,interview_age)) + geom_point(color = "black") + geom_smooth(method = "loess")
```

For below models, view Internalizing above for notes.

# Externalizing

## CBCL + AP Longitudinal Models
```{r}
external_zinb_r <- glmm.zinb(cbcl_scr_syn_external_r ~ interview_age.c9.y + race_ethnicity.bl + high.educ.bl+ prnt.empl.bl  + neighb_phenx_avg_p.bl.cm + overall.income.bl + sex.bl, random = ~1|abcd_site/subjectid,
              zi_fixed = ~ interview_age.c9.y + race_ethnicity.bl + high.educ.bl+ prnt.empl.bl  + neighb_phenx_avg_p.bl.cm + overall.income.bl + sex.bl, zi_random = ~1|abcd_site, data = df_cc)

summary(external_zinb_r)
summary(external_zinb_r$zi.fit)
anova(external_zinb_r)
VarCorr(external_zinb_r)
```

## Assumption checking for ZINB Models
```{r}
#Check outlier/residuals with this df
external_res <- df_cc
external_res$level1_resid.raw <- residuals(external_zinb_r)
external_res$level1_resid.pearson <- residuals(external_zinb_r, type="pearson")
#Add predicted values (Yhat)
external_res$cbcl_scr_syn_external_r_predicted <- predict(external_zinb_r,external_res,type="response")
#Incidence
external_res$incidence <- estimate.probability(external_res$cbcl_scr_syn_external_r, method="empirical")

#Plotting histogram of residuals, but may be skewed since using ZINB, so make sure to check below plots
hist(external_res$level1_resid.pearson)
```
### Incidence vs. X's Plots
```{r}
#age
ggplot(external_res,aes(incidence,interview_age)) + geom_point(color = "black") + geom_smooth(method = "loess")
```
### Residuals vs Y (CBCL Outcome) Plot
```{r}
plot(external_res$level1_resid.pearson, external_res$cbcl_scr_syn_external_r)
```
### Residuals vs Yhat Plot
```{r}
plot(external_res$level1_resid.pearson, external_res$cbcl_scr_syn_external_r_predicted)
```
### Residuals vs Row Plot
```{r}
plot(as.numeric(rownames(external_res)),external_res$level1_resid.pearson)
```
### Residuals vs X's Plots
```{r}
#age
ggplot(external_res,aes(level1_resid.pearson,interview_age)) + geom_point(color = "black") + geom_smooth(method = "loess")
```

# Anxious/Depressed

## CBCL + AP Longitudinal Models
```{r}
anxdep_zinb_r <- glmm.zinb(cbcl_scr_syn_anxdep_r ~ interview_age.c9.y + race_ethnicity.bl + high.educ.bl+ prnt.empl.bl  + neighb_phenx_avg_p.bl.cm + overall.income.bl + sex.bl, random = ~1|abcd_site/subjectid,
              zi_fixed = ~ interview_age.c9.y + race_ethnicity.bl + high.educ.bl+ prnt.empl.bl  + neighb_phenx_avg_p.bl.cm + overall.income.bl + sex.bl, zi_random = ~1|abcd_site, data = df_cc)

summary(anxdep_zinb_r)
summary(anxdep_zinb_r$zi.fit)
anova(anxdep_zinb_r)
```

## Assumption checking for ZINB Models
```{r}
#Check outlier/residuals with this df
anxdep_res <- df_cc
anxdep_res$level1_resid.raw <- residuals(anxdep_zinb_r)
anxdep_res$level1_resid.pearson <- residuals(anxdep_zinb_r, type="pearson")
#Add predicted values (Yhat)
anxdep_res$cbcl_scr_syn_anxdep_r_predicted <- predict(anxdep_zinb_r,anxdep_res,type="response")
#Incidence
anxdep_res$incidence <- estimate.probability(anxdep_res$cbcl_scr_syn_anxdep_r, method="empirical")

#Plotting histogram of residuals, but may be skewed since using ZINB, so make sure to check below plots
hist(anxdep_res$level1_resid.pearson)
```
### Incidence vs. X's Plots
```{r}
#age
ggplot(anxdep_res,aes(incidence,interview_age)) + geom_point(color = "black") + geom_smooth(method = "loess")
```
### Residuals vs Y (CBCL Outcome) Plot
```{r}
plot(anxdep_res$level1_resid.pearson, anxdep_res$cbcl_scr_syn_anxdep_r)
```
### Residuals vs Yhat Plot
```{r}
plot(anxdep_res$level1_resid.pearson, anxdep_res$cbcl_scr_syn_anxdep_r_predicted)
```
### Residuals vs Row Plot
```{r}
plot(as.numeric(rownames(anxdep_res)),anxdep_res$level1_resid.pearson)
```
### Residuals vs X's Plots
```{r}
#age
ggplot(anxdep_res,aes(level1_resid.pearson,interview_age)) + geom_point(color = "black") + geom_smooth(method = "loess")
```

# Withdrawn/Depressed

## CBCL + AP Longitudinal Models
```{r}
withdep_zinb_r <- glmm.zinb(cbcl_scr_syn_withdep_r ~ interview_age.c9.y + race_ethnicity.bl + high.educ.bl+ prnt.empl.bl  + neighb_phenx_avg_p.bl.cm + overall.income.bl + sex.bl, random = ~1|abcd_site/subjectid,
              zi_fixed = ~ interview_age.c9.y + race_ethnicity.bl + high.educ.bl+ prnt.empl.bl  + neighb_phenx_avg_p.bl.cm + overall.income.bl + sex.bl, zi_random = ~1|abcd_site, data = df_cc)

summary(withdep_zinb_r)
summary(withdep_zinb_r$zi.fit)
anova(withdep_zinb_r)
```

## Assumption checking for ZINB Models
```{r}
#Check outlier/residuals with this df
withdep_res <- df_cc
withdep_res$level1_resid.raw <- residuals(withdep_zinb_r)
withdep_res$level1_resid.pearson <- residuals(withdep_zinb_r, type="pearson")
#Add predicted values (Yhat)
withdep_res$cbcl_scr_syn_withdep_r_predicted <- predict(withdep_zinb_r,withdep_res,type="response")
#Incidence
withdep_res$incidence <- estimate.probability(withdep_res$cbcl_scr_syn_withdep_r, method="empirical")

#Plotting histogram of residuals, but may be skewed since using ZINB, so make sure to check below plots
hist(withdep_res$level1_resid.pearson)
```
### Incidence vs. X's Plots
```{r}
#age
ggplot(withdep_res,aes(incidence,interview_age)) + geom_point(color = "black") + geom_smooth(method = "loess")
```
### Residuals vs Y (CBCL Outcome) Plot
```{r}
plot(withdep_res$level1_resid.pearson, withdep_res$cbcl_scr_syn_withdep_r)
```
### Residuals vs Yhat Plot
```{r}
plot(withdep_res$level1_resid.pearson, withdep_res$cbcl_scr_syn_withdep_r_predicted)
```
### Residuals vs Row Plot
```{r}
plot(as.numeric(rownames(withdep_res)),withdep_res$level1_resid.pearson)
```
### Residuals vs X's Plots
```{r}
#age
ggplot(withdep_res,aes(level1_resid.pearson,interview_age)) + geom_point(color = "black") + geom_smooth(method = "loess")
```



# Attention

## CBCL + AP Longitudinal Models
```{r}
attention_zinb_r <- glmm.zinb(cbcl_scr_syn_attention_r ~ interview_age.c9.y + race_ethnicity.bl + high.educ.bl+ prnt.empl.bl  + neighb_phenx_avg_p.bl.cm + overall.income.bl + sex.bl, random = ~1|abcd_site/subjectid,
              zi_fixed = ~ interview_age.c9.y + race_ethnicity.bl + high.educ.bl+ prnt.empl.bl  + neighb_phenx_avg_p.bl.cm + overall.income.bl + sex.bl, zi_random = ~1|abcd_site, data = df_cc)

summary(attention_zinb_r)
summary(attention_zinb_r$zi.fit)
anova(attention_zinb_r)
```

## Assumption checking for ZINB Models
```{r}
#Check outlier/residuals with this df
attention_res <- df_cc
attention_res$level1_resid.raw <- residuals(attention_zinb_r)
attention_res$level1_resid.pearson <- residuals(attention_zinb_r, type="pearson")
#Add predicted values (Yhat)
attention_res$cbcl_scr_syn_attention_r_predicted <- predict(attention_zinb_r,attention_res,type="response")
#Incidence
attention_res$incidence <- estimate.probability(attention_res$cbcl_scr_syn_attention_r, method="empirical")

#Plotting histogram of residuals, but may be skewed since using ZINB, so make sure to check below plots
hist(attention_res$level1_resid.pearson)
```
### Incidence vs. X's Plots
```{r}
#age
ggplot(attention_res,aes(incidence,interview_age)) + geom_point(color = "black") + geom_smooth(method = "loess")
```
### Residuals vs Y (CBCL Outcome) Plot
```{r}
plot(attention_res$level1_resid.pearson, attention_res$cbcl_scr_syn_attention_r)
```
### Residuals vs Yhat Plot
```{r}
plot(attention_res$level1_resid.pearson, attention_res$cbcl_scr_syn_attention_r_predicted)
```
### Residuals vs Row Plot
```{r}
plot(as.numeric(rownames(attention_res)),attention_res$level1_resid.pearson)
```
### Residuals vs X's Plots
```{r}
#age
ggplot(attention_res,aes(level1_resid.pearson,interview_age)) + geom_point(color = "black") + geom_smooth(method = "loess")
```

# Rulebreak

## CBCL + AP Longitudinal Models
```{r}
rulebreak_zinb_r <- glmm.zinb(cbcl_scr_syn_rulebreak_r ~ interview_age.c9.y + race_ethnicity.bl + high.educ.bl+ prnt.empl.bl  + neighb_phenx_avg_p.bl.cm + overall.income.bl + sex.bl, random = ~1|abcd_site/subjectid,
              zi_fixed = ~ interview_age.c9.y + race_ethnicity.bl + high.educ.bl+ prnt.empl.bl  + neighb_phenx_avg_p.bl.cm + overall.income.bl + sex.bl, zi_random = ~1|abcd_site, data = df_cc)

summary(rulebreak_zinb_r)
summary(rulebreak_zinb_r$zi.fit)
anova(rulebreak_zinb_r)
```

## Assumption checking for ZINB Models
```{r}
#Check outlier/residuals with this df
rulebreak_res <- df_cc
rulebreak_res$level1_resid.raw <- residuals(rulebreak_zinb_r)
rulebreak_res$level1_resid.pearson <- residuals(rulebreak_zinb_r, type="pearson")
#Add predicted values (Yhat)
rulebreak_res$cbcl_scr_syn_rulebreak_r_predicted <- predict(rulebreak_zinb_r,rulebreak_res,type="response")
#Incidence
rulebreak_res$incidence <- estimate.probability(rulebreak_res$cbcl_scr_syn_rulebreak_r, method="empirical")

#Plotting histogram of residuals, but may be skewed since using ZINB, so make sure to check below plots
hist(rulebreak_res$level1_resid.pearson)
```
### Incidence vs. X's Plots
```{r}
#age
ggplot(rulebreak_res,aes(incidence,interview_age)) + geom_point(color = "black") + geom_smooth(method = "loess")
```
### Residuals vs Y (CBCL Outcome) Plot
```{r}
plot(rulebreak_res$level1_resid.pearson, rulebreak_res$cbcl_scr_syn_rulebreak_r)
```
### Residuals vs Yhat Plot
```{r}
plot(rulebreak_res$level1_resid.pearson, rulebreak_res$cbcl_scr_syn_rulebreak_r_predicted)
```
### Residuals vs Row Plot
```{r}
plot(as.numeric(rownames(rulebreak_res)),rulebreak_res$level1_resid.pearson)
```
### Residuals vs X's Plots
```{r}
#age
ggplot(rulebreak_res,aes(level1_resid.pearson,interview_age)) + geom_point(color = "black") + geom_smooth(method = "loess")
```

# Aggressive

## CBCL + AP Longitudinal Models
```{r}
aggressive_zinb_r <- glmm.zinb(cbcl_scr_syn_aggressive_r ~ interview_age.c9.y + race_ethnicity.bl + high.educ.bl+ prnt.empl.bl  + neighb_phenx_avg_p.bl.cm + overall.income.bl + sex.bl, random = ~1|abcd_site/subjectid,
              zi_fixed = ~ interview_age.c9.y + race_ethnicity.bl + high.educ.bl+ prnt.empl.bl  + neighb_phenx_avg_p.bl.cm + overall.income.bl + sex.bl, zi_random = ~1|abcd_site, data = df_cc)

summary(aggressive_zinb_r)
summary(aggressive_zinb_r$zi.fit)
anova(aggressive_zinb_r)
```

## Assumption checking for ZINB Models
```{r}
#Check outlier/residuals with this df
aggressive_res <- df_cc
aggressive_res$level1_resid.raw <- residuals(aggressive_zinb_r)
aggressive_res$level1_resid.pearson <- residuals(aggressive_zinb_r, type="pearson")
#Add predicted values (Yhat)
aggressive_res$cbcl_scr_syn_aggressive_r_predicted <- predict(aggressive_zinb_r,aggressive_res,type="response")
#Incidence
aggressive_res$incidence <- estimate.probability(aggressive_res$cbcl_scr_syn_aggressive_r, method="empirical")

#Plotting histogram of residuals, but may be skewed since using ZINB, so make sure to check below plots
hist(aggressive_res$level1_resid.pearson)
```
### Incidence vs. X's Plots
```{r}
#age
ggplot(aggressive_res,aes(incidence,interview_age)) + geom_point(color = "black") + geom_smooth(method = "loess")
```
### Residuals vs Y (CBCL Outcome) Plot
```{r}
plot(aggressive_res$level1_resid.pearson, aggressive_res$cbcl_scr_syn_aggressive_r)
```
### Residuals vs Yhat Plot
```{r}
plot(aggressive_res$level1_resid.pearson, aggressive_res$cbcl_scr_syn_aggressive_r_predicted)
```
### Residuals vs Row Plot
```{r}
plot(as.numeric(rownames(aggressive_res)),aggressive_res$level1_resid.pearson)
```
### Residuals vs X's Plots
```{r}
#age
ggplot(aggressive_res,aes(level1_resid.pearson,interview_age)) + geom_point(color = "black") + geom_smooth(method = "loess")
```

```{r eval=F}
#take snapshot to update documentation for environment dependencies
renv::snapshot()
```

