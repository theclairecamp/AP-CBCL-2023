---
title: 'CBCL~NO2*Age+Covariates Models with Tables and Graphs'
author: "Claire Campbell; prior data cleaning by Hedyeh Ahmadi"
date: "Version `r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    fig_caption: yes
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: no
  word_document:
    toc: yes
    toc_depth: '4'
  pdf_document:
    toc: yes
    toc_depth: '4'
editor_options:
  chunk_output_rype: console
  chunk_output_type: console
---

<style type="text/css">

body, td {
   font-size: 13px;
}
code.r{
  font-size: 11px;
}
pre {
  font-size: 11px
}
</style>


# R set up

Script not shown in the HTML file.

Note that the data cleaning and exploration for this analysis is in a separate file called 
"HEI-Aim2-Data-Cleaning-Exploration-0219-2021".


```{r}
#Clear existing data and graphics
rm(list = ls(all.names = TRUE)) #will clear all objects includes hidden objects.
graphics.off()
invisible(gc()) #free up memory and report the memory usage.
```


```{r}
knitr::opts_chunk$set(echo = TRUE)

# To create Pdf
library(knitr)

# Importing Data
library(haven)
library(readxl)

# Table specific
library(xtable)
library(kableExtra)

# Data Cleaning and plotting
library(tidyverse)
library(dplyr)
library(plyr)
library(ggplot2)
library(scales)
library(ggeffects)

# ggplot common legend
library(ggpubr)

# Skewness library
library(e1071)

# Matrix operations
library(matrixStats)

# Mixed Models
library(lme4)
library(nlme)
library(lmerTest) # to get p-values for lmer
require (HLMdiag) # Model diagnostics

# Recoding for the whole data frame
library(naniar)

# To read the lables
library(Hmisc)

# to order the data
library(doBy)

# to re-code variables
library(rockchalk)

# for reshape
library(MASS)

# descriptive and more
library(psych)

# correlogram plot
library(corrplot)

# vif
library(car)

#glmer diagnostics
library("fitdistrplus")

#outlier analysis and R^2
library(performance)

# linearity plot of glmer
library(ggResidpanel)

# interaction plots 
library(sjPlot)

#interaction plots
library(emmeans)

# Creating stratified tables
library(arsenal)

#For zero-inflated negative binomial modeling/model checking
library(NBZIMM)
library(nlme)
library(philentropy)

#For inverse logit
library(boot)

#Plot organizing
library(gridExtra)
```

# Importing the Clean Data
```{r}
HEI_Aim2_Long <- read.csv("HEI_Aim2_Long.csv")
HEI_Aim2_Wide <- read.csv("HEI_Aim2_Wide.csv")

HEI_Aim2_Long_1KidPerFamily <- read.csv("HEI_Aim2_Long_1KidPerFamily.csv")
dim(HEI_Aim2_Long)
dim(HEI_Aim2_Wide)
dim(HEI_Aim2_Long_1KidPerFamily)


names(HEI_Aim2_Long)
names(HEI_Aim2_Wide)
names(HEI_Aim2_Long_1KidPerFamily)


# Note we are keeping all families but choosing one kid per family
length(unique(HEI_Aim2_Long$rel_family_id))
length(unique(HEI_Aim2_Long$subjectid)) # matches number of rows of wide data :)

length(unique(HEI_Aim2_Long_1KidPerFamily$rel_family_id))
length(unique(HEI_Aim2_Long_1KidPerFamily$subjectid))
```

## Copy baseline variables to all timepoints for full df
```{r}
#rename so can use later
names(HEI_Aim2_Long)[names(HEI_Aim2_Long) == 'prnt.empl.bl'] <- 'prnt.empl.b'

#create dataset for table and comparison
baseline_vars <- subset(HEI_Aim2_Long, HEI_Aim2_Long$eventname=="Baseline", select = c("subjectid", "sex", "race_ethnicity", "high.educ", "neighb_phenx_avg_p", "overall.income.b", "prnt.empl.b"))

#rename variables
names(baseline_vars)[names(baseline_vars) == 'sex'] <- 'sex.bl'
names(baseline_vars)[names(baseline_vars) == 'race_ethnicity'] <- 'race_ethnicity.bl'
names(baseline_vars)[names(baseline_vars) == 'high.educ'] <- 'high.educ.bl'
names(baseline_vars)[names(baseline_vars) == 'neighb_phenx_avg_p'] <- 'neighb_phenx_avg_p.bl'
names(baseline_vars)[names(baseline_vars) == 'overall.income.b'] <- 'overall.income.bl'
names(baseline_vars)[names(baseline_vars) == 'prnt.empl.b'] <- 'prnt.empl.bl'

#add to initial df
HEI_Aim2_Long_2 <- merge(HEI_Aim2_Long, baseline_vars, by="subjectid")
```

## Descriptive Table before Cleaning
```{r}
#factor eventname
HEI_Aim2_Long_2$eventname <- as.factor(HEI_Aim2_Long_2$eventname)
HEI_Aim2_Long_2$eventname <- relevel(HEI_Aim2_Long_2$eventname , ref="Baseline")

#create smaller df
df_prior <- subset(HEI_Aim2_Long_2,select=c("subjectid","abcd_site","eventname","interview_age","reshist_addr1_pm252016aa_bl","prnt.empl.bl","overall.income.bl","sex.bl","race_ethnicity.bl","high.educ.bl","neighb_phenx_avg_p.bl","cbcl_scr_syn_internal_r","cbcl_scr_syn_external_r","cbcl_scr_syn_anxdep_r","cbcl_scr_syn_withdep_r","cbcl_scr_syn_attention_r","cbcl_scr_syn_rulebreak_r","cbcl_scr_syn_aggressive_r","cbcl_scr_syn_totprob_r"))
#create table
des_table_prior <- tableby(eventname ~ ., data = df_prior[ , -which(names(df_prior) %in% c("subjectid"))], total=F) 
summary(des_table_prior, title = "Descriptive Statistics by Eventname Before Cleaning")
```

# Creating variables for modeling and tables

The following variables are time-invariant, will use baseline covariates since PM2.5 collected at baseline:
- reshist_addr1_pm252016aa_bl which is the Baseline PM2.5.
- reshist_addr1_no2_2016_aavg_bl which is the Baseline NO2.
- sex.bl
- race_ethnicity.bl
- high.educ.bl
- prnt.empl.bl 
- neighb_phenx_avg_p.bl
- overall.income.bl 


The following variables are time-varying:
- all CBCL outcomes
- interview_age

## Copy baseline variables to all timepoints for 1KidPerFamily
```{r}
#rename so can use later
names(HEI_Aim2_Long_1KidPerFamily)[names(HEI_Aim2_Long_1KidPerFamily) == 'prnt.empl.bl'] <- 'prnt.empl.b'

#create dataset for table and comparison
baseline_vars_1KidPerFamily <- subset(HEI_Aim2_Long_1KidPerFamily, HEI_Aim2_Long_1KidPerFamily$eventname=="Baseline", select = c("subjectid", "sex", "race_ethnicity", "high.educ", "neighb_phenx_avg_p", "overall.income.b"))

#rename variables
names(baseline_vars_1KidPerFamily)[names(baseline_vars_1KidPerFamily) == 'sex'] <- 'sex.bl'
names(baseline_vars_1KidPerFamily)[names(baseline_vars_1KidPerFamily) == 'race_ethnicity'] <- 'race_ethnicity.bl'
names(baseline_vars_1KidPerFamily)[names(baseline_vars_1KidPerFamily) == 'high.educ'] <- 'high.educ.bl'
names(baseline_vars_1KidPerFamily)[names(baseline_vars_1KidPerFamily) == 'neighb_phenx_avg_p'] <- 'neighb_phenx_avg_p.bl'
names(baseline_vars_1KidPerFamily)[names(baseline_vars_1KidPerFamily) == 'overall.income.b'] <- 'overall.income.bl'
names(baseline_vars_1KidPerFamily)[names(baseline_vars_1KidPerFamily) == 'prnt.empl.b'] <- 'prnt.empl.bl'

#add to initial df
HEI_Aim2_Long_1KidPerFamily_2 <- merge(HEI_Aim2_Long_1KidPerFamily, baseline_vars, by="subjectid")
```

## Clean 1KidPerFamily
```{r}
## Cleaning
#merge Asian into Other group b/c statistically Asian group is too small
tapply(HEI_Aim2_Long_1KidPerFamily_2$race_ethnicity.bl, 
       HEI_Aim2_Long_1KidPerFamily_2$eventname,table, useNA = "always")

HEI_Aim2_Long_1KidPerFamily_2$race_ethnicity.bl <- 
  ifelse(HEI_Aim2_Long_1KidPerFamily_2$race_ethnicity.bl=="Asian","Other",
         HEI_Aim2_Long_1KidPerFamily_2$race_ethnicity.bl)

tapply(HEI_Aim2_Long_1KidPerFamily_2$race_ethnicity.bl, 
       HEI_Aim2_Long_1KidPerFamily_2$eventname,table, useNA = "always")

#reformat variables
HEI_Aim2_Long_1KidPerFamily_2$eventname <- 
  as.factor(HEI_Aim2_Long_1KidPerFamily_2$eventname)

HEI_Aim2_Long_1KidPerFamily_2$eventname <- 
  relevel(HEI_Aim2_Long_1KidPerFamily_2$eventname , ref="Baseline")

table(HEI_Aim2_Long_1KidPerFamily_2$eventname, useNA = "always")


HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_internal_r <- as.numeric(HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_internal_r)
HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_external_r <- as.numeric(HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_external_r)
HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_anxdep_r <- as.numeric(HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_anxdep_r)
HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_withdep_r <- as.numeric(HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_withdep_r)
HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_attention_r <- as.numeric(HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_attention_r)
HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_rulebreak_r <- as.numeric(HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_rulebreak_r)
HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_aggressive_r <- as.numeric(HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_aggressive_r)
HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_totprob_r <- as.numeric(HEI_Aim2_Long_1KidPerFamily_2$cbcl_scr_syn_totprob_r)
HEI_Aim2_Long_1KidPerFamily_2$abcd_site <- as.factor(HEI_Aim2_Long_1KidPerFamily_2$abcd_site)
HEI_Aim2_Long_1KidPerFamily_2$subjectid <- as.factor(HEI_Aim2_Long_1KidPerFamily_2$subjectid)
HEI_Aim2_Long_1KidPerFamily_2$prnt.empl.bl <- factor(HEI_Aim2_Long_1KidPerFamily_2$prnt.empl.bl, levels = c("Employed", "Stay at Home Parent", "Unemployed", "Other"))
HEI_Aim2_Long_1KidPerFamily_2$overall.income.bl <- factor(HEI_Aim2_Long_1KidPerFamily_2$overall.income.bl, levels = c("[>=100K]", "[>=50K & <100K]", "[<50k]", "[Don't Know or Refuse]"))
HEI_Aim2_Long_1KidPerFamily_2$sex.bl <- factor(HEI_Aim2_Long_1KidPerFamily_2$sex.bl, levels = c("Male", "Female"))
HEI_Aim2_Long_1KidPerFamily_2$race_ethnicity.bl <- factor(HEI_Aim2_Long_1KidPerFamily_2$race_ethnicity.bl, levels = c("White", "Hispanic", "Black", "Other"))
HEI_Aim2_Long_1KidPerFamily_2$high.educ.bl <- factor(HEI_Aim2_Long_1KidPerFamily_2$high.educ.bl, levels = c("Post Graduate Degree", "Bachelor", "Some College", "HS Diploma/GED", "< HS Diploma"))
```

## Create Final Dataset
```{r results='asis'}
#create smaller df
df <- subset(HEI_Aim2_Long_1KidPerFamily_2,select=c("subjectid","abcd_site","eventname","interview_age","reshist_addr1_pm252016aa_bl","reshist_addr1_no2_2016_aavg_bl","prnt.empl.bl","overall.income.bl","sex.bl","race_ethnicity.bl","high.educ.bl","neighb_phenx_avg_p.bl","cbcl_scr_syn_internal_r","cbcl_scr_syn_external_r","cbcl_scr_syn_anxdep_r","cbcl_scr_syn_withdep_r","cbcl_scr_syn_attention_r","cbcl_scr_syn_rulebreak_r","cbcl_scr_syn_aggressive_r"))

#complete cases because needed for zinb
df_cc <- df[complete.cases(df),]

#center age at 9years-old (i.e., 108 months)
df_cc$interview_age.c9 <- df_cc$interview_age-108
#change to years
df_cc$interview_age.c9.y <- df_cc$interview_age.c9/12
#scale pm2.5 by SD
#df_cc$reshist_addr1_pm252016aa_bl.scaled <- scale(df_cc$reshist_addr1_pm252016aa_bl, center = TRUE, scale = TRUE)
#center pm2.5 to 5 (recommended by WHO)
df_cc$reshist_addr1_pm252016aa_bl.c5 <- df_cc$reshist_addr1_pm252016aa_bl-5
#center no2 to 5.33 (recommended by WHO)
df_cc$reshist_addr1_no2_2016_aavg_bl.c533 <- df_cc$reshist_addr1_no2_2016_aavg_bl-5.33

#center around mean
neighb_phenx_avg_p.bl.cm <- df_cc$neighb_phenx_avg_p.bl - mean(df_cc$neighb_phenx_avg_p.bl)

#correlation between pm2.5 and no2
cor(df_cc$reshist_addr1_pm252016aa_bl.c5[df_cc$eventname=="Baseline"], df_cc$reshist_addr1_no2_2016_aavg_bl.c533[df_cc$eventname=="Baseline"], method="pearson")
```

# CBCL + AP Longitudinal Models with PM2.5 added as a covariate
```{r}
#internal
internal_zinb_r <- glmm.zinb(cbcl_scr_syn_internal_r ~ reshist_addr1_no2_2016_aavg_bl.c533*interview_age.c9.y + race_ethnicity.bl + high.educ.bl+ prnt.empl.bl  + neighb_phenx_avg_p.bl.cm + overall.income.bl + sex.bl + reshist_addr1_pm252016aa_bl.c5, random = ~1|abcd_site/subjectid, 
              zi_fixed = ~ reshist_addr1_no2_2016_aavg_bl.c533*interview_age.c9.y + race_ethnicity.bl + high.educ.bl+ prnt.empl.bl  + neighb_phenx_avg_p.bl.cm + overall.income.bl + sex.bl + reshist_addr1_pm252016aa_bl.c5, zi_random = ~1|abcd_site, data = df_cc)

#external
external_zinb_r <- glmm.zinb(cbcl_scr_syn_external_r ~ reshist_addr1_no2_2016_aavg_bl.c533*interview_age.c9.y + race_ethnicity.bl + high.educ.bl+ prnt.empl.bl  + neighb_phenx_avg_p.bl.cm + overall.income.bl + sex.bl + reshist_addr1_pm252016aa_bl.c5, random = ~1|abcd_site/subjectid, 
              zi_fixed = ~ reshist_addr1_no2_2016_aavg_bl.c533*interview_age.c9.y + race_ethnicity.bl + high.educ.bl+ prnt.empl.bl  + neighb_phenx_avg_p.bl.cm + overall.income.bl + sex.bl + reshist_addr1_pm252016aa_bl.c5, zi_random = ~1|abcd_site, data = df_cc)

#anxdep
anxdep_zinb_r <- glmm.zinb(cbcl_scr_syn_anxdep_r ~ reshist_addr1_no2_2016_aavg_bl.c533*interview_age.c9.y + race_ethnicity.bl + high.educ.bl+ prnt.empl.bl  + neighb_phenx_avg_p.bl.cm + overall.income.bl + sex.bl + reshist_addr1_pm252016aa_bl.c5, random = ~1|abcd_site/subjectid, 
              zi_fixed = ~ reshist_addr1_no2_2016_aavg_bl.c533*interview_age.c9.y + race_ethnicity.bl + high.educ.bl+ prnt.empl.bl  + neighb_phenx_avg_p.bl.cm + overall.income.bl + sex.bl + reshist_addr1_pm252016aa_bl.c5, zi_random = ~1|abcd_site, data = df_cc)

#withdep
withdep_zinb_r <- glmm.zinb(cbcl_scr_syn_withdep_r ~ reshist_addr1_no2_2016_aavg_bl.c533*interview_age.c9.y + race_ethnicity.bl + high.educ.bl+ prnt.empl.bl  + neighb_phenx_avg_p.bl.cm + overall.income.bl + sex.bl + reshist_addr1_pm252016aa_bl.c5, random = ~1|abcd_site/subjectid, 
              zi_fixed = ~ reshist_addr1_no2_2016_aavg_bl.c533*interview_age.c9.y + race_ethnicity.bl + high.educ.bl+ prnt.empl.bl  + neighb_phenx_avg_p.bl.cm + overall.income.bl + sex.bl + reshist_addr1_pm252016aa_bl.c5, zi_random = ~1|abcd_site, data = df_cc)

#attention
attention_zinb_r <- glmm.zinb(cbcl_scr_syn_attention_r ~ reshist_addr1_no2_2016_aavg_bl.c533*interview_age.c9.y + race_ethnicity.bl + high.educ.bl+ prnt.empl.bl  + neighb_phenx_avg_p.bl.cm + overall.income.bl + sex.bl + reshist_addr1_pm252016aa_bl.c5, random = ~1|abcd_site/subjectid, 
              zi_fixed = ~ reshist_addr1_no2_2016_aavg_bl.c533*interview_age.c9.y + race_ethnicity.bl + high.educ.bl+ prnt.empl.bl  + neighb_phenx_avg_p.bl.cm + overall.income.bl + sex.bl + reshist_addr1_pm252016aa_bl.c5, zi_random = ~1|abcd_site, data = df_cc)

#rulebreak
rulebreak_zinb_r <- glmm.zinb(cbcl_scr_syn_rulebreak_r ~ reshist_addr1_no2_2016_aavg_bl.c533*interview_age.c9.y + race_ethnicity.bl + high.educ.bl+ prnt.empl.bl  + neighb_phenx_avg_p.bl.cm + overall.income.bl + sex.bl + reshist_addr1_pm252016aa_bl.c5, random = ~1|abcd_site/subjectid, 
              zi_fixed = ~ reshist_addr1_no2_2016_aavg_bl.c533*interview_age.c9.y + race_ethnicity.bl + high.educ.bl+ prnt.empl.bl  + neighb_phenx_avg_p.bl.cm + overall.income.bl + sex.bl + reshist_addr1_pm252016aa_bl.c5, zi_random = ~1|abcd_site, data = df_cc)

#aggressive
aggressive_zinb_r <- glmm.zinb(cbcl_scr_syn_aggressive_r ~ reshist_addr1_no2_2016_aavg_bl.c533*interview_age.c9.y + race_ethnicity.bl + high.educ.bl+ prnt.empl.bl  + neighb_phenx_avg_p.bl.cm + overall.income.bl + sex.bl + reshist_addr1_pm252016aa_bl.c5, random = ~1|abcd_site/subjectid, 
              zi_fixed = ~ reshist_addr1_no2_2016_aavg_bl.c533*interview_age.c9.y + race_ethnicity.bl + high.educ.bl+ prnt.empl.bl  + neighb_phenx_avg_p.bl.cm + overall.income.bl + sex.bl + reshist_addr1_pm252016aa_bl.c5, zi_random = ~1|abcd_site, data = df_cc)
```

# FDR Correction for count function with pm2.5 as covariate
```{r}
#calculate fdr values
#internal
internal_fdr <- as.data.frame(summary(internal_zinb_r)$tTable[,1:2])
internal_fdr$Pvalue <- summary(internal_zinb_r)$tTable[,5]
rownames(internal_fdr) <- paste0("internal.", rownames(internal_fdr))
#external
external_fdr <- as.data.frame(summary(external_zinb_r)$tTable[,1:2])
external_fdr$Pvalue <- summary(external_zinb_r)$tTable[,5]
rownames(external_fdr) <- paste0("external.", rownames(external_fdr))
#anxdep
anxdep_fdr <- as.data.frame(summary(anxdep_zinb_r)$tTable[,1:2])
anxdep_fdr$Pvalue <- summary(anxdep_zinb_r)$tTable[,5]
rownames(anxdep_fdr) <- paste0("anxdep.", rownames(anxdep_fdr))
#withdep
withdep_fdr <- as.data.frame(summary(withdep_zinb_r)$tTable[,1:2])
withdep_fdr$Pvalue <- summary(withdep_zinb_r)$tTable[,5]
rownames(withdep_fdr) <- paste0("withdep.", rownames(withdep_fdr))
#attention
attention_fdr <- as.data.frame(summary(attention_zinb_r)$tTable[,1:2])
attention_fdr$Pvalue <- summary(attention_zinb_r)$tTable[,5]
rownames(attention_fdr) <- paste0("attention.", rownames(attention_fdr))
#rulebreak
rulebreak_fdr <- as.data.frame(summary(rulebreak_zinb_r)$tTable[,1:2])
rulebreak_fdr$Pvalue <- summary(rulebreak_zinb_r)$tTable[,5]
rownames(rulebreak_fdr) <- paste0("rulebreak.", rownames(rulebreak_fdr))
#aggressive
aggressive_fdr <- as.data.frame(summary(aggressive_zinb_r)$tTable[,1:2])
aggressive_fdr$Pvalue <- summary(aggressive_zinb_r)$tTable[,5]
rownames(aggressive_fdr) <- paste0("aggressive.", rownames(aggressive_fdr))

#all age (interview_age.c9.y)
age_fdr <- rbind(internal_fdr[c("internal.interview_age.c9.y"),],external_fdr[c("external.interview_age.c9.y"),],anxdep_fdr[c("anxdep.interview_age.c9.y"),],withdep_fdr[c("withdep.interview_age.c9.y"),],attention_fdr[c("attention.interview_age.c9.y"),],rulebreak_fdr[c("rulebreak.interview_age.c9.y"),],aggressive_fdr[c("aggressive.interview_age.c9.y"),])
age_fdr$FDR.corr <- p.adjust(age_fdr$Pvalue, method="fdr")
#all no2 (reshist_addr1_no2_2016_aavg_bl.c533)
no2_fdr <- rbind(internal_fdr[c("internal.reshist_addr1_no2_2016_aavg_bl.c533"),],external_fdr[c("external.reshist_addr1_no2_2016_aavg_bl.c533"),],anxdep_fdr[c("anxdep.reshist_addr1_no2_2016_aavg_bl.c533"),],withdep_fdr[c("withdep.reshist_addr1_no2_2016_aavg_bl.c533"),],attention_fdr[c("attention.reshist_addr1_no2_2016_aavg_bl.c533"),],rulebreak_fdr[c("rulebreak.reshist_addr1_no2_2016_aavg_bl.c533"),],aggressive_fdr[c("aggressive.reshist_addr1_no2_2016_aavg_bl.c533"),])
no2_fdr$FDR.corr <- p.adjust(no2_fdr$Pvalue, method="fdr")
#all no2 (reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y)
no2byage_fdr <- rbind(internal_fdr[c("internal.reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y"),],external_fdr[c("external.reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y"),],anxdep_fdr[c("anxdep.reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y"),],withdep_fdr[c("withdep.reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y"),],attention_fdr[c("attention.reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y"),],rulebreak_fdr[c("rulebreak.reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y"),],aggressive_fdr[c("aggressive.reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y"),])
no2byage_fdr$FDR.corr <- p.adjust(no2byage_fdr$Pvalue, method="fdr")

#combine all
all_fdr <- rbind(age_fdr,no2_fdr,no2byage_fdr)
#write.csv(all_fdr,"all_fdr_values_no2.models.csv")
```

# FDR Correction for zero-inflated function with pm2.5 as covariate
```{r}
#calculate fdr values
#internal
internal_fdr.zi <- as.data.frame(summary(internal_zinb_r$zi.fit)$tTable[,1:2])
internal_fdr.zi$Pvalue <- summary(internal_zinb_r$zi.fit)$tTable[,5]
rownames(internal_fdr.zi) <- paste0("internal.", rownames(internal_fdr.zi))
#external
external_fdr.zi <- as.data.frame(summary(external_zinb_r$zi.fit)$tTable[,1:2])
external_fdr.zi$Pvalue <- summary(external_zinb_r$zi.fit)$tTable[,5]
rownames(external_fdr.zi) <- paste0("external.", rownames(external_fdr.zi))
#anxdep
anxdep_fdr.zi <- as.data.frame(summary(anxdep_zinb_r$zi.fit)$tTable[,1:2])
anxdep_fdr.zi$Pvalue <- summary(anxdep_zinb_r$zi.fit)$tTable[,5]
rownames(anxdep_fdr.zi) <- paste0("anxdep.", rownames(anxdep_fdr.zi))
#withdep
withdep_fdr.zi <- as.data.frame(summary(withdep_zinb_r$zi.fit)$tTable[,1:2])
withdep_fdr.zi$Pvalue <- summary(withdep_zinb_r$zi.fit)$tTable[,5]
rownames(withdep_fdr.zi) <- paste0("withdep.", rownames(withdep_fdr.zi))
#attention
attention_fdr.zi <- as.data.frame(summary(attention_zinb_r$zi.fit)$tTable[,1:2])
attention_fdr.zi$Pvalue <- summary(attention_zinb_r$zi.fit)$tTable[,5]
rownames(attention_fdr.zi) <- paste0("attention.", rownames(attention_fdr.zi))
#rulebreak
rulebreak_fdr.zi <- as.data.frame(summary(rulebreak_zinb_r$zi.fit)$tTable[,1:2])
rulebreak_fdr.zi$Pvalue <- summary(rulebreak_zinb_r$zi.fit)$tTable[,5]
rownames(rulebreak_fdr.zi) <- paste0("rulebreak.", rownames(rulebreak_fdr.zi))
#aggressive
aggressive_fdr.zi <- as.data.frame(summary(aggressive_zinb_r$zi.fit)$tTable[,1:2])
aggressive_fdr.zi$Pvalue <- summary(aggressive_zinb_r$zi.fit)$tTable[,5]
rownames(aggressive_fdr.zi) <- paste0("aggressive.", rownames(aggressive_fdr.zi))

#all age (interview_age.c9.y)
age_fdr.zi <- rbind(internal_fdr.zi[c("internal.interview_age.c9.y"),],external_fdr.zi[c("external.interview_age.c9.y"),],anxdep_fdr.zi[c("anxdep.interview_age.c9.y"),],withdep_fdr.zi[c("withdep.interview_age.c9.y"),],attention_fdr.zi[c("attention.interview_age.c9.y"),],rulebreak_fdr.zi[c("rulebreak.interview_age.c9.y"),],aggressive_fdr.zi[c("aggressive.interview_age.c9.y"),])
age_fdr.zi$FDR.corr <- p.adjust(age_fdr.zi$Pvalue, method="fdr")
#all no2 (reshist_addr1_no2_2016_aavg_bl.c533)
no2_fdr.zi <- rbind(internal_fdr.zi[c("internal.reshist_addr1_no2_2016_aavg_bl.c533"),],external_fdr.zi[c("external.reshist_addr1_no2_2016_aavg_bl.c533"),],anxdep_fdr.zi[c("anxdep.reshist_addr1_no2_2016_aavg_bl.c533"),],withdep_fdr.zi[c("withdep.reshist_addr1_no2_2016_aavg_bl.c533"),],attention_fdr.zi[c("attention.reshist_addr1_no2_2016_aavg_bl.c533"),],rulebreak_fdr.zi[c("rulebreak.reshist_addr1_no2_2016_aavg_bl.c533"),],aggressive_fdr.zi[c("aggressive.reshist_addr1_no2_2016_aavg_bl.c533"),])
no2_fdr.zi$FDR.corr <- p.adjust(no2_fdr.zi$Pvalue, method="fdr")
#all no2 (reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y)
no2byage_fdr.zi <- rbind(internal_fdr.zi[c("internal.reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y"),],external_fdr.zi[c("external.reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y"),],anxdep_fdr.zi[c("anxdep.reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y"),],withdep_fdr.zi[c("withdep.reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y"),],attention_fdr.zi[c("attention.reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y"),],rulebreak_fdr.zi[c("rulebreak.reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y"),],aggressive_fdr.zi[c("aggressive.reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y"),])
no2byage_fdr.zi$FDR.corr <- p.adjust(no2byage_fdr.zi$Pvalue, method="fdr")

#combine all
all_fdr.zi <- rbind(age_fdr.zi,no2_fdr.zi,no2byage_fdr.zi)
#write.csv(all_fdr.zi,"all_fdr_values_no2.models.zi.csv")
```

# Plot interaction outcomes: use method on [this site] (https://stats.oarc.ucla.edu/stata/faq/how-can-i-manually-generate-the-predicted-counts-from-a-zip-or-zinb-model-based-on-the-parameter-estimates/), Example 3, to calculate values manually
## Internalizing
```{r}
#calculate the values at 9 and 12 years (centered at 9 yrs) at no2 = 5.33 & 26.1 ppb (centered at 5.33 ppb)

#df
internal_prediction_intx <- data.frame(CBCL=c("internal","internal","internal","internal"), Ages=c(0,3,0,3), NO2_levels=c(0,0,20.77,20.77))

#coefficients
##zi
inter_coef_zi_internal <- fixef(summary(internal_zinb_r$zi.fit))["(Intercept)"]
no2_coef_zi_internal <- fixef(summary(internal_zinb_r$zi.fit))["reshist_addr1_no2_2016_aavg_bl.c533"]
age_coef_zi_internal <- fixef(summary(internal_zinb_r$zi.fit))["interview_age.c9.y"]
intx_coef_zi_internal <- fixef(summary(internal_zinb_r$zi.fit))["reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y"]
##count
inter_coef_ct_internal <- fixef(summary(internal_zinb_r))["(Intercept)"]
no2_coef_ct_internal <- fixef(summary(internal_zinb_r))["reshist_addr1_no2_2016_aavg_bl.c533"]
age_coef_ct_internal <- fixef(summary(internal_zinb_r))["interview_age.c9.y"]
intx_coef_ct_internal <- fixef(summary(internal_zinb_r))["reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y"]

#calculate values
##zi
internal_prediction_intx$zi <- (inter_coef_zi_internal + no2_coef_zi_internal*internal_prediction_intx$NO2_levels + age_coef_zi_internal*internal_prediction_intx$Ages + intx_coef_zi_internal*internal_prediction_intx$NO2_levels*internal_prediction_intx$Ages)
##count
internal_prediction_intx$count <- (inter_coef_ct_internal + no2_coef_ct_internal*internal_prediction_intx$NO2_levels + age_coef_ct_internal*internal_prediction_intx$Ages + intx_coef_ct_internal*internal_prediction_intx$NO2_levels*internal_prediction_intx$Ages)

#calculate predictions
internal_prediction_intx$pzero <- exp(internal_prediction_intx$zi) / (1+exp(internal_prediction_intx$zi))
internal_prediction_intx$pcount <- exp(internal_prediction_intx$count) * (1-internal_prediction_intx$pzero)

#calculate differences
##zi
no5.33_internal_pzero <- ((internal_prediction_intx[2,6] - internal_prediction_intx[1,6]) / internal_prediction_intx[1,6]) * 100
round(no5.33_internal_pzero)
#12% decrease
no26.1_internal_pzero <- ((internal_prediction_intx[4,6] - internal_prediction_intx[3,6]) / internal_prediction_intx[3,6]) * 100
round(no26.1_internal_pzero)
#102% increase
##count
no5.33_internal_pcount <- ((internal_prediction_intx[2,7] - internal_prediction_intx[1,7]) / internal_prediction_intx[1,7]) * 100
round(no5.33_internal_pcount)
#13% increase
no26.1_internal_pcount <- ((internal_prediction_intx[4,7] - internal_prediction_intx[3,7]) / internal_prediction_intx[3,7]) * 100
round(no26.1_internal_pcount)
#6% decrease

#Plot zi model
internal_intx_zi <- 
  ggplot(internal_prediction_intx, aes(x=factor(Ages), y=pzero, color=factor(NO2_levels), group=factor(NO2_levels))) +
  geom_line() +
  geom_point() +
  labs(title=bquote(bold(NO[2]*"-by-age Interaction")), x="Age (years)", y="Probability of Zero", color=bquote(NO[2])) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"), legend.position = "none") +
  scale_x_discrete(breaks = c(0, 3),label = c("9", "12")) +
  scale_y_continuous(breaks=c(0, 0.01, 0.02, 0.03, 0.04, 0.05), label=c("0%","1%","2%","3%","4%","5%"), limits=c(0,0.05)) +
  scale_color_manual(values=c("orchid1","darkorchid3"),labels=c('5.33 ppb', '26.1 ppb')) +
  annotate("label", x = c(1.5, 1.5), y = c(0.025,0.006), 
           label = c("12% decrease","106% increase"), 
           family = "", fontface = "bold", size=4, 
           color=c("orchid1","darkorchid3"))

#plot count model
internal_intx_ct <- 
  ggplot(internal_prediction_intx, aes(x=factor(Ages), y=pcount, color=factor(NO2_levels), group=factor(NO2_levels))) +
  geom_line() +
  geom_point() +
  labs(title=bquote(bold(NO[2]*"-by-age Interaction")), x="Age (years)", y="Predicted Score", color=bquote(NO[2])) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"), legend.position = "none") +
  scale_x_discrete(breaks = c(0, 3),label = c("9", "12")) +
  scale_y_continuous(limits=c(0,5)) +
  scale_color_manual(values=c("orchid1","darkorchid3"),labels=c('5.33 ppb', '26.1 ppb')) +
  annotate("label", x = c(1.5, 1.5), y = c(4.4,2.9), 
           label = c("13% increase","6% decrease"), 
           family = "", fontface = "bold", size=4, 
           color=c("orchid1","darkorchid3"))
```

## Externalizing
```{r}
#calculate the values at 9 and 12 years (centered at 9 yrs) at no2 = 5.33 & 26.1 ppb (centered at 5.33 ppb)

#df
external_prediction_intx <- data.frame(CBCL=c("external","external","external","external"), Ages=c(0,3,0,3), NO2_levels=c(0,0,20.77,20.77))

#coefficients
##zi
inter_coef_zi_external <- fixef(summary(external_zinb_r$zi.fit))["(Intercept)"]
no2_coef_zi_external <- fixef(summary(external_zinb_r$zi.fit))["reshist_addr1_no2_2016_aavg_bl.c533"]
age_coef_zi_external <- fixef(summary(external_zinb_r$zi.fit))["interview_age.c9.y"]
intx_coef_zi_external <- fixef(summary(external_zinb_r$zi.fit))["reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y"]
##count
inter_coef_ct_external <- fixef(summary(external_zinb_r))["(Intercept)"]
no2_coef_ct_external <- fixef(summary(external_zinb_r))["reshist_addr1_no2_2016_aavg_bl.c533"]
age_coef_ct_external <- fixef(summary(external_zinb_r))["interview_age.c9.y"]
intx_coef_ct_external <- fixef(summary(external_zinb_r))["reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y"]

#calculate values
##zi
external_prediction_intx$zi <- (inter_coef_zi_external + no2_coef_zi_external*external_prediction_intx$NO2_levels + age_coef_zi_external*external_prediction_intx$Ages + intx_coef_zi_external*external_prediction_intx$NO2_levels*external_prediction_intx$Ages)
##count
external_prediction_intx$count <- (inter_coef_ct_external + no2_coef_ct_external*external_prediction_intx$NO2_levels + age_coef_ct_external*external_prediction_intx$Ages + intx_coef_ct_external*external_prediction_intx$NO2_levels*external_prediction_intx$Ages)

#calculate predictions
external_prediction_intx$pzero <- exp(external_prediction_intx$zi) / (1+exp(external_prediction_intx$zi))
external_prediction_intx$pcount <- exp(external_prediction_intx$count) * (1-external_prediction_intx$pzero)

#calculate differences
##zi
no5.33_external_pzero <- ((external_prediction_intx[2,6] - external_prediction_intx[1,6]) / external_prediction_intx[1,6]) * 100
round(no5.33_external_pzero)
#79% increase
no26.1_external_pzero <- ((external_prediction_intx[4,6] - external_prediction_intx[3,6]) / external_prediction_intx[3,6]) * 100
round(no26.1_external_pzero)
#95% increase
##count
no5.33_external_pcount <- ((external_prediction_intx[2,7] - external_prediction_intx[1,7]) / external_prediction_intx[1,7]) * 100
round(no5.33_external_pcount)
#3% decrease
no26.1_external_pcount <- ((external_prediction_intx[4,7] - external_prediction_intx[3,7]) / external_prediction_intx[3,7]) * 100
round(no26.1_external_pcount)
#17% decrease

#Plot zi model
external_intx_zi <- 
  ggplot(external_prediction_intx, aes(x=factor(Ages), y=pzero, color=factor(NO2_levels), group=factor(NO2_levels))) +
  geom_line() +
  geom_point() +
  labs(title=bquote(bold(NO[2]*"-by-age Interaction")), x="Age (years)", y="Probability of Zero", color=bquote(NO[2])) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"), legend.position = "none") +
  scale_x_discrete(breaks = c(0, 3),label = c("9", "12")) +
  scale_y_continuous(breaks=c(0, 0.01, 0.02, 0.03, 0.04, 0.05), label=c("0%","1%","2%","3%","4%","5%"), limits=c(0,0.05)) +
  scale_color_manual(values=c("orchid1","darkorchid3"),labels=c('5.33 ppb', '26.1 ppb')) +
  annotate("label", x = c(1.5,1.5), y = c(0.033,0.009), 
           label = c("79% increase","95% increase"), 
           family = "", fontface = "bold", size=4, 
           color=c("orchid1","darkorchid3"))

#plot count model
external_intx_ct <- 
  ggplot(external_prediction_intx, aes(x=factor(Ages), y=pcount, color=factor(NO2_levels), group=factor(NO2_levels))) +
  geom_line() +
  geom_point() +
  labs(title=bquote(bold(NO[2]*"-by-age Interaction")), x="Age (years)", y="Predicted Score", color=bquote(NO[2])) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"), legend.position = "none") +
  scale_x_discrete(breaks = c(0, 3),label = c("9", "12")) +
  scale_y_continuous(limits=c(0,5)) +
  scale_color_manual(values=c("orchid1","darkorchid3"),labels=c('5.33 ppb', '26.1 ppb')) +
  annotate("label", x = c(1.5, 1.5), y = c(3.1,1.8), 
           label = c("3% decrease","17% decrease"), 
           family = "", fontface = "bold", size=4, 
           color=c("orchid1","darkorchid3"))
```

## Anxious/Depressed
```{r}
#calculate the values at 9 and 12 years (centered at 9 yrs) at no2 = 5.33 & 26.1 ppb (centered at 5.33 ppb)

#df
anxdep_prediction_intx <- data.frame(CBCL=c("anxdep","anxdep","anxdep","anxdep"), Ages=c(0,3,0,3), NO2_levels=c(0,0,20.77,20.77))

#coefficients
##zi
inter_coef_zi_anxdep <- fixef(summary(anxdep_zinb_r$zi.fit))["(Intercept)"]
no2_coef_zi_anxdep <- fixef(summary(anxdep_zinb_r$zi.fit))["reshist_addr1_no2_2016_aavg_bl.c533"]
age_coef_zi_anxdep <- fixef(summary(anxdep_zinb_r$zi.fit))["interview_age.c9.y"]
intx_coef_zi_anxdep <- fixef(summary(anxdep_zinb_r$zi.fit))["reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y"]
##count
inter_coef_ct_anxdep <- fixef(summary(anxdep_zinb_r))["(Intercept)"]
no2_coef_ct_anxdep <- fixef(summary(anxdep_zinb_r))["reshist_addr1_no2_2016_aavg_bl.c533"]
age_coef_ct_anxdep <- fixef(summary(anxdep_zinb_r))["interview_age.c9.y"]
intx_coef_ct_anxdep <- fixef(summary(anxdep_zinb_r))["reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y"]

#calculate values
##zi
anxdep_prediction_intx$zi <- (inter_coef_zi_anxdep + no2_coef_zi_anxdep*anxdep_prediction_intx$NO2_levels + age_coef_zi_anxdep*anxdep_prediction_intx$Ages + intx_coef_zi_anxdep*anxdep_prediction_intx$NO2_levels*anxdep_prediction_intx$Ages)
##count
anxdep_prediction_intx$count <- (inter_coef_ct_anxdep + no2_coef_ct_anxdep*anxdep_prediction_intx$NO2_levels + age_coef_ct_anxdep*anxdep_prediction_intx$Ages + intx_coef_ct_anxdep*anxdep_prediction_intx$NO2_levels*anxdep_prediction_intx$Ages)

#calculate predictions
anxdep_prediction_intx$pzero <- exp(anxdep_prediction_intx$zi) / (1+exp(anxdep_prediction_intx$zi))
anxdep_prediction_intx$pcount <- exp(anxdep_prediction_intx$count) * (1-anxdep_prediction_intx$pzero)

#calculate differences
##zi
no5.33_anxdep_pzero <- ((anxdep_prediction_intx[2,6] - anxdep_prediction_intx[1,6]) / anxdep_prediction_intx[1,6]) * 100
round(no5.33_anxdep_pzero)
#25% increase
no26.1_anxdep_pzero <- ((anxdep_prediction_intx[4,6] - anxdep_prediction_intx[3,6]) / anxdep_prediction_intx[3,6]) * 100
round(no26.1_anxdep_pzero)
#374% increase
##count
no5.33_anxdep_pcount <- ((anxdep_prediction_intx[2,7] - anxdep_prediction_intx[1,7]) / anxdep_prediction_intx[1,7]) * 100
round(no5.33_anxdep_pcount)
#0% increase
no26.1_anxdep_pcount <- ((anxdep_prediction_intx[4,7] - anxdep_prediction_intx[3,7]) / anxdep_prediction_intx[3,7]) * 100
round(no26.1_anxdep_pcount)
#12% decrease

#Plot zi model
anxdep_intx_zi <- 
  ggplot(anxdep_prediction_intx, aes(x=factor(Ages), y=pzero, color=factor(NO2_levels), group=factor(NO2_levels))) +
  geom_line() +
  geom_point() +
  labs(title=bquote(bold(NO[2]*"-by-age Interaction")), x="Age (years)", y="Probability of Zero", color=bquote(NO[2])) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"), legend.position = "none") +
  scale_x_discrete(breaks = c(0, 3),label = c("9", "12")) +
  scale_y_continuous(breaks=c(0, 0.01, 0.02, 0.03, 0.04, 0.05), label=c("0%","1%","2%","3%","4%","5%"), limits=c(0,0.05)) +
  scale_color_manual(values=c("orchid1","darkorchid3"),labels=c('5.33 ppb', '26.1 ppb')) +
  annotate("label", x = c(1.5, 1.5), y = c(0.001,0.025), 
           label = c("25% increase","374% increase"), 
           family = "", fontface = "bold", size=4, 
           color=c("orchid1","darkorchid3"))  

#plot count model
anxdep_intx_ct <- 
  ggplot(anxdep_prediction_intx, aes(x=factor(Ages), y=pcount, color=factor(NO2_levels), group=factor(NO2_levels))) +
  geom_line() +
  geom_point() +
  labs(title=bquote(bold(NO[2]*"-by-age Interaction")), x="Age (years)", y="Predicted Score", color=bquote(NO[2])) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"), legend.position = "none") +
  scale_x_discrete(breaks = c(0, 3),label = c("9", "12")) +
  scale_y_continuous(limits=c(0,5)) +
  scale_color_manual(values=c("orchid1","darkorchid3"),labels=c('5.33 ppb', '26.1 ppb')) +
  annotate("label", x = c(1.5, 1.5), y = c(2.4,1.2), 
           label = c("0% change","12% decrease"), 
           family = "", fontface = "bold", size=4, 
           color=c("orchid1","darkorchid3"))
```

## Withdrawn/Depressed
```{r}
#calculate the values at 9 and 12 years (centered at 9 yrs) at no2 = 5.33 & 26.1 ppb (centered at 5.33 ppb)

#df
withdep_prediction_intx <- data.frame(CBCL=c("withdep","withdep","withdep","withdep"), Ages=c(0,3,0,3), NO2_levels=c(0,0,20.77,20.77))

#coefficients
##zi
inter_coef_zi_withdep <- fixef(summary(withdep_zinb_r$zi.fit))["(Intercept)"]
no2_coef_zi_withdep <- fixef(summary(withdep_zinb_r$zi.fit))["reshist_addr1_no2_2016_aavg_bl.c533"]
age_coef_zi_withdep <- fixef(summary(withdep_zinb_r$zi.fit))["interview_age.c9.y"]
intx_coef_zi_withdep <- fixef(summary(withdep_zinb_r$zi.fit))["reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y"]
##count
inter_coef_ct_withdep <- fixef(summary(withdep_zinb_r))["(Intercept)"]
no2_coef_ct_withdep <- fixef(summary(withdep_zinb_r))["reshist_addr1_no2_2016_aavg_bl.c533"]
age_coef_ct_withdep <- fixef(summary(withdep_zinb_r))["interview_age.c9.y"]
intx_coef_ct_withdep <- fixef(summary(withdep_zinb_r))["reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y"]

#calculate values
##zi
withdep_prediction_intx$zi <- (inter_coef_zi_withdep + no2_coef_zi_withdep*withdep_prediction_intx$NO2_levels + age_coef_zi_withdep*withdep_prediction_intx$Ages + intx_coef_zi_withdep*withdep_prediction_intx$NO2_levels*withdep_prediction_intx$Ages)
##count
withdep_prediction_intx$count <- (inter_coef_ct_withdep + no2_coef_ct_withdep*withdep_prediction_intx$NO2_levels + age_coef_ct_withdep*withdep_prediction_intx$Ages + intx_coef_ct_withdep*withdep_prediction_intx$NO2_levels*withdep_prediction_intx$Ages)

#calculate predictions
withdep_prediction_intx$pzero <- exp(withdep_prediction_intx$zi) / (1+exp(withdep_prediction_intx$zi))
withdep_prediction_intx$pcount <- exp(withdep_prediction_intx$count) * (1-withdep_prediction_intx$pzero)

#calculate differences
##zi
no5.33_withdep_pzero <- ((withdep_prediction_intx[2,6] - withdep_prediction_intx[1,6]) / withdep_prediction_intx[1,6]) * 100
round(no5.33_withdep_pzero)
#74% decrease
no26.1_withdep_pzero <- ((withdep_prediction_intx[4,6] - withdep_prediction_intx[3,6]) / withdep_prediction_intx[3,6]) * 100
round(no26.1_withdep_pzero)
#11% decrease
##count
no5.33_withdep_pcount <- ((withdep_prediction_intx[2,7] - withdep_prediction_intx[1,7]) / withdep_prediction_intx[1,7]) * 100
round(no5.33_withdep_pcount)
#57% increase
no26.1_withdep_pcount <- ((withdep_prediction_intx[4,7] - withdep_prediction_intx[3,7]) / withdep_prediction_intx[3,7]) * 100
round(no26.1_withdep_pcount)
#23% increase

#Plot zi model
withdep_intx_zi <- 
  ggplot(withdep_prediction_intx, aes(x=factor(Ages), y=pzero, color=factor(NO2_levels), group=factor(NO2_levels))) +
  geom_line() +
  geom_point() +
  labs(title=bquote(bold(NO[2]*"-by-age Interaction")), x="Age (years)", y="Probability of Zero", color=bquote(NO[2])) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"), legend.position = "none") +
  scale_x_discrete(breaks = c(0, 3),label = c("9", "12")) +
  scale_y_continuous(breaks=c(0, 0.01, 0.02, 0.03, 0.04, 0.05), label=c("0%","1%","2%","3%","4%","5%"), limits=c(0,0.05)) +
  scale_color_manual(values=c("orchid1","darkorchid3"),labels=c('5.33 ppb', '26.1 ppb')) +
  annotate("label", x = c(1.5, 1.1), y = c(0.043,0.017), 
           label = c("74% decrease","11% decrease"), 
           family = "", fontface = "bold", size=4, 
           color=c("orchid1","darkorchid3"))  

#plot count model
withdep_intx_ct <- 
  ggplot(withdep_prediction_intx, aes(x=factor(Ages), y=pcount, color=factor(NO2_levels), group=factor(NO2_levels))) +
  geom_line() +
  geom_point() +
  labs(title=bquote(bold(NO[2]*"-by-age Interaction")), x="Age (years)", y="Predicted Score", color=bquote(NO[2])) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"), legend.position = "none") +
  scale_x_discrete(breaks = c(0, 3),label = c("9", "12")) +
  scale_y_continuous(limits=c(0,5)) +
  scale_color_manual(values=c("orchid1","darkorchid3"),labels=c('5.33 ppb', '26.1 ppb')) +
  annotate("label", x = c(1.5, 1.5), y = c(1.1,0.08), 
           label = c("57% increase","23% increase"), 
           family = "", fontface = "bold", size=4, 
           color=c("orchid1","darkorchid3"))
```

## Attention
```{r}
#calculate the values at 9 and 12 years (centered at 9 yrs) at no2 = 5.33 & 26.1 ppb (centered at 5.33 ppb)

#df
attention_prediction_intx <- data.frame(CBCL=c("attention","attention","attention","attention"), Ages=c(0,3,0,3), NO2_levels=c(0,0,20.77,20.77))

#coefficients
##zi
inter_coef_zi_attention <- fixef(summary(attention_zinb_r$zi.fit))["(Intercept)"]
no2_coef_zi_attention <- fixef(summary(attention_zinb_r$zi.fit))["reshist_addr1_no2_2016_aavg_bl.c533"]
age_coef_zi_attention <- fixef(summary(attention_zinb_r$zi.fit))["interview_age.c9.y"]
intx_coef_zi_attention <- fixef(summary(attention_zinb_r$zi.fit))["reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y"]
##count
inter_coef_ct_attention <- fixef(summary(attention_zinb_r))["(Intercept)"]
no2_coef_ct_attention <- fixef(summary(attention_zinb_r))["reshist_addr1_no2_2016_aavg_bl.c533"]
age_coef_ct_attention <- fixef(summary(attention_zinb_r))["interview_age.c9.y"]
intx_coef_ct_attention <- fixef(summary(attention_zinb_r))["reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y"]

#calculate values
##zi
attention_prediction_intx$zi <- (inter_coef_zi_attention + no2_coef_zi_attention*attention_prediction_intx$NO2_levels + age_coef_zi_attention*attention_prediction_intx$Ages + intx_coef_zi_attention*attention_prediction_intx$NO2_levels*attention_prediction_intx$Ages)
##count
attention_prediction_intx$count <- (inter_coef_ct_attention + no2_coef_ct_attention*attention_prediction_intx$NO2_levels + age_coef_ct_attention*attention_prediction_intx$Ages + intx_coef_ct_attention*attention_prediction_intx$NO2_levels*attention_prediction_intx$Ages)

#calculate predictions
attention_prediction_intx$pzero <- exp(attention_prediction_intx$zi) / (1+exp(attention_prediction_intx$zi))
attention_prediction_intx$pcount <- exp(attention_prediction_intx$count) * (1-attention_prediction_intx$pzero)

#calculate differences
##zi
no5.33_attention_pzero <- ((attention_prediction_intx[2,6] - attention_prediction_intx[1,6]) / attention_prediction_intx[1,6]) * 100
round(no5.33_attention_pzero)
#141% increase
no26.1_attention_pzero <- ((attention_prediction_intx[4,6] - attention_prediction_intx[3,6]) / attention_prediction_intx[3,6]) * 100
round(no26.1_attention_pzero)
#9% increase
##count
no5.33_attention_pcount <- ((attention_prediction_intx[2,7] - attention_prediction_intx[1,7]) / attention_prediction_intx[1,7]) * 100
round(no5.33_attention_pcount)
#1% increase
no26.1_attention_pcount <- ((attention_prediction_intx[4,7] - attention_prediction_intx[3,7]) / attention_prediction_intx[3,7]) * 100
round(no26.1_attention_pcount)
#16% decrease

#Plot zi model
attention_intx_zi <- 
  ggplot(attention_prediction_intx, aes(x=factor(Ages), y=pzero, color=factor(NO2_levels), group=factor(NO2_levels))) +
  geom_line() +
  geom_point() +
  labs(title=bquote(bold(NO[2]*"-by-age Interaction")), x="Age (years)", y="Probability of Zero", color=bquote(NO[2])) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"), legend.position = "none") +
  scale_x_discrete(breaks = c(0, 3),label = c("9", "12")) +
  scale_y_continuous(breaks=c(0, 0.01, 0.02, 0.03, 0.04, 0.05), label=c("0%","1%","2%","3%","4%","5%"), limits=c(0,0.05)) +
  scale_color_manual(values=c("orchid1","darkorchid3"),labels=c('5.33 ppb', '26.1 ppb')) +
  annotate("label", x = c(1.5, 1.5), y = c(0.015,0.0009), 
           label = c("141% increase","9% increase"), 
           family = "", fontface = "bold", size=4, 
           color=c("orchid1","darkorchid3")) 

#plot count model
attention_intx_ct <- 
  ggplot(attention_prediction_intx, aes(x=factor(Ages), y=pcount, color=factor(NO2_levels), group=factor(NO2_levels))) +
  geom_line() +
  geom_point() +
  labs(title=bquote(bold(NO[2]*"-by-age Interaction")), x="Age (years)", y="Predicted Score", color=bquote(NO[2])) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"), legend.position = "none") +
  scale_x_discrete(breaks = c(0, 3),label = c("9", "12")) +
  scale_y_continuous(limits=c(0,5)) +
  scale_color_manual(values=c("orchid1","darkorchid3"),labels=c('5.33 ppb', '26.1 ppb')) +
  annotate("label", x = c(1.5, 1.5), y = c(2.5,1.2), 
           label = c("1% increase","16% decrease"), 
           family = "", fontface = "bold", size=4, 
           color=c("orchid1","darkorchid3"))
```

## Rulebreaking
```{r}
#calculate the values at 9 and 12 years (centered at 9 yrs) at no2 = 5.33 & 26.1 ppb (centered at 5.33 ppb)

#df
rulebreak_prediction_intx <- data.frame(CBCL=c("rulebreak","rulebreak","rulebreak","rulebreak"), Ages=c(0,3,0,3), NO2_levels=c(0,0,20.77,20.77))

#coefficients
##zi
inter_coef_zi_rulebreak <- fixef(summary(rulebreak_zinb_r$zi.fit))["(Intercept)"]
no2_coef_zi_rulebreak <- fixef(summary(rulebreak_zinb_r$zi.fit))["reshist_addr1_no2_2016_aavg_bl.c533"]
age_coef_zi_rulebreak <- fixef(summary(rulebreak_zinb_r$zi.fit))["interview_age.c9.y"]
intx_coef_zi_rulebreak <- fixef(summary(rulebreak_zinb_r$zi.fit))["reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y"]
##count
inter_coef_ct_rulebreak <- fixef(summary(rulebreak_zinb_r))["(Intercept)"]
no2_coef_ct_rulebreak <- fixef(summary(rulebreak_zinb_r))["reshist_addr1_no2_2016_aavg_bl.c533"]
age_coef_ct_rulebreak <- fixef(summary(rulebreak_zinb_r))["interview_age.c9.y"]
intx_coef_ct_rulebreak <- fixef(summary(rulebreak_zinb_r))["reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y"]

#calculate values
##zi
rulebreak_prediction_intx$zi <- (inter_coef_zi_rulebreak + no2_coef_zi_rulebreak*rulebreak_prediction_intx$NO2_levels + age_coef_zi_rulebreak*rulebreak_prediction_intx$Ages + intx_coef_zi_rulebreak*rulebreak_prediction_intx$NO2_levels*rulebreak_prediction_intx$Ages)
##count
rulebreak_prediction_intx$count <- (inter_coef_ct_rulebreak + no2_coef_ct_rulebreak*rulebreak_prediction_intx$NO2_levels + age_coef_ct_rulebreak*rulebreak_prediction_intx$Ages + intx_coef_ct_rulebreak*rulebreak_prediction_intx$NO2_levels*rulebreak_prediction_intx$Ages)

#calculate predictions
rulebreak_prediction_intx$pzero <- exp(rulebreak_prediction_intx$zi) / (1+exp(rulebreak_prediction_intx$zi))
rulebreak_prediction_intx$pcount <- exp(rulebreak_prediction_intx$count) * (1-rulebreak_prediction_intx$pzero)

#calculate differences
##zi
no5.33_rulebreak_pzero <- ((rulebreak_prediction_intx[2,6] - rulebreak_prediction_intx[1,6]) / rulebreak_prediction_intx[1,6]) * 100
round(no5.33_rulebreak_pzero)
#27% increase
no26.1_rulebreak_pzero <- ((rulebreak_prediction_intx[4,6] - rulebreak_prediction_intx[3,6]) / rulebreak_prediction_intx[3,6]) * 100
round(no26.1_rulebreak_pzero)
#175% increase
##count
no5.33_rulebreak_pcount <- ((rulebreak_prediction_intx[2,7] - rulebreak_prediction_intx[1,7]) / rulebreak_prediction_intx[1,7]) * 100
round(no5.33_rulebreak_pcount)
#2% increase
no26.1_rulebreak_pcount <- ((rulebreak_prediction_intx[4,7] - rulebreak_prediction_intx[3,7]) / rulebreak_prediction_intx[3,7]) * 100
round(no26.1_rulebreak_pcount)
#16% decrease

#Plot zi model
rulebreak_intx_zi <- 
  ggplot(rulebreak_prediction_intx, aes(x=factor(Ages), y=pzero, color=factor(NO2_levels), group=factor(NO2_levels))) +
  geom_line() +
  geom_point() +
  labs(title=bquote(bold(NO[2]*"-by-age Interaction")), x="Age (years)", y="Probability of Zero", color=bquote(NO[2])) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"), legend.position = "none") +
  scale_x_discrete(breaks = c(0, 3),label = c("9", "12")) +
  scale_y_continuous(breaks=c(0, 0.01, 0.02, 0.03, 0.04, 0.05), label=c("0%","1%","2%","3%","4%","5%"), limits=c(0,0.05)) +
  scale_color_manual(values=c("orchid1","darkorchid3"),labels=c('5.33 ppb', '26.1 ppb')) +
  annotate("label", x = c(1.5, 1.5), y = c(0.007,0.03), 
           label = c("27% increase","175% increase"), 
           family = "", fontface = "bold", size=4, 
           color=c("orchid1","darkorchid3")) 

#plot count model
rulebreak_intx_ct <- 
  ggplot(rulebreak_prediction_intx, aes(x=factor(Ages), y=pcount, color=factor(NO2_levels), group=factor(NO2_levels))) +
  geom_line() +
  geom_point() +
  labs(title=bquote(bold(NO[2]*"-by-age Interaction")), x="Age (years)", y="Predicted Score", color=bquote(NO[2])) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"), legend.position = "none") +
  scale_x_discrete(breaks = c(0, 3),label = c("9", "12")) +
  scale_y_continuous(limits=c(0,5)) +
  scale_color_manual(values=c("orchid1","darkorchid3"),labels=c('5.33 ppb', '26.1 ppb')) +
  annotate("label", x = c(1.5, 1.5), y = c(1,0.1), 
           label = c("2% increase","16% decrease"), 
           family = "", fontface = "bold", size=4, 
           color=c("orchid1","darkorchid3"))
```

## Aggressive
```{r}
#calculate the values at 9 and 12 years (centered at 9 yrs) at no2 = 5.33 & 26.1 ppb (centered at 5.33 ppb)

#df
aggressive_prediction_intx <- data.frame(CBCL=c("aggressive","aggressive","aggressive","aggressive"), Ages=c(0,3,0,3), NO2_levels=c(0,0,20.77,20.77))

#coefficients
##zi
inter_coef_zi_aggressive <- fixef(summary(aggressive_zinb_r$zi.fit))["(Intercept)"]
no2_coef_zi_aggressive <- fixef(summary(aggressive_zinb_r$zi.fit))["reshist_addr1_no2_2016_aavg_bl.c533"]
age_coef_zi_aggressive <- fixef(summary(aggressive_zinb_r$zi.fit))["interview_age.c9.y"]
intx_coef_zi_aggressive <- fixef(summary(aggressive_zinb_r$zi.fit))["reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y"]
##count
inter_coef_ct_aggressive <- fixef(summary(aggressive_zinb_r))["(Intercept)"]
no2_coef_ct_aggressive <- fixef(summary(aggressive_zinb_r))["reshist_addr1_no2_2016_aavg_bl.c533"]
age_coef_ct_aggressive <- fixef(summary(aggressive_zinb_r))["interview_age.c9.y"]
intx_coef_ct_aggressive <- fixef(summary(aggressive_zinb_r))["reshist_addr1_no2_2016_aavg_bl.c533:interview_age.c9.y"]

#calculate values
##zi
aggressive_prediction_intx$zi <- (inter_coef_zi_aggressive + no2_coef_zi_aggressive*aggressive_prediction_intx$NO2_levels + age_coef_zi_aggressive*aggressive_prediction_intx$Ages + intx_coef_zi_aggressive*aggressive_prediction_intx$NO2_levels*aggressive_prediction_intx$Ages)
##count
aggressive_prediction_intx$count <- (inter_coef_ct_aggressive + no2_coef_ct_aggressive*aggressive_prediction_intx$NO2_levels + age_coef_ct_aggressive*aggressive_prediction_intx$Ages + intx_coef_ct_aggressive*aggressive_prediction_intx$NO2_levels*aggressive_prediction_intx$Ages)

#calculate predictions
aggressive_prediction_intx$pzero <- exp(aggressive_prediction_intx$zi) / (1+exp(aggressive_prediction_intx$zi))
aggressive_prediction_intx$pcount <- exp(aggressive_prediction_intx$count) * (1-aggressive_prediction_intx$pzero)

#calculate differences
##zi
no5.33_aggressive_pzero <- ((aggressive_prediction_intx[2,6] - aggressive_prediction_intx[1,6]) / aggressive_prediction_intx[1,6]) * 100
round(no5.33_aggressive_pzero)
#116% increase
no26.1_aggressive_pzero <- ((aggressive_prediction_intx[4,6] - aggressive_prediction_intx[3,6]) / aggressive_prediction_intx[3,6]) * 100
round(no26.1_aggressive_pzero)
#102% increase
##count
no5.33_aggressive_pcount <- ((aggressive_prediction_intx[2,7] - aggressive_prediction_intx[1,7]) / aggressive_prediction_intx[1,7]) * 100
round(no5.33_aggressive_pcount)
#5% decrease
no26.1_aggressive_pcount <- ((aggressive_prediction_intx[4,7] - aggressive_prediction_intx[3,7]) / aggressive_prediction_intx[3,7]) * 100
round(no26.1_aggressive_pcount)
#18% decrease

#Plot zi model
aggressive_intx_zi <- 
  ggplot(aggressive_prediction_intx, aes(x=factor(Ages), y=pzero, color=factor(NO2_levels), group=factor(NO2_levels))) +
  geom_line() +
  geom_point() +
  labs(title=bquote(bold(NO[2]*"-by-age Interaction")), x="Age (years)", y="Probability of Zero", color=bquote(NO[2])) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"), legend.position = "none") +
  scale_x_discrete(breaks = c(0, 3),label = c("9", "12")) +
  scale_y_continuous(breaks=c(0, 0.01, 0.02, 0.03, 0.04, 0.05), label=c("0%","1%","2%","3%","4%","5%"), limits=c(0,0.05)) +
  scale_color_manual(values=c("orchid1","darkorchid3"),labels=c('5.33 ppb', '26.1 ppb')) +
  annotate("label", x = c(1.5,1.5), y = c(0.03,0.006), 
           label = c("116% increase","102% increase"), 
           family = "", fontface = "bold", size=4, 
           color=c("orchid1","darkorchid3"))

#plot count model
aggressive_intx_ct <- 
  ggplot(aggressive_prediction_intx, aes(x=factor(Ages), y=pcount, color=factor(NO2_levels), group=factor(NO2_levels))) +
  geom_line() +
  geom_point() +
  labs(title=bquote(bold(NO[2]*"-by-age Interaction")), x="Age (years)", y="Predicted Score", color=bquote(NO[2])) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"), legend.position = "none") +
  scale_x_discrete(breaks = c(0, 3),label = c("9", "12")) +
  scale_y_continuous(limits=c(0,5)) +
  scale_color_manual(values=c("orchid1","darkorchid3"),labels=c('5.33 ppb', '26.1 ppb')) +
  annotate("label", x = c(1.5, 1.5), y = c(2.4,1.2), 
           label = c("5% decrease","18% decrease"), 
           family = "", fontface = "bold", size=4, 
           color=c("orchid1","darkorchid3"))
```

##Export above graphs
```{r}
#internal
ggsave(internal_intx_zi,device="png",filename="Figures/NO2_Internal_ZI_Figures_2.27.23.png",width=4,height=4, units = "in")
ggsave(internal_intx_ct,device="png",filename="Figures/NO2_Internal_Count_Figures_2.27.23.png",width=4,height=4, units = "in")

#external
ggsave(external_intx_zi,device="png",filename="Figures/NO2_External_ZI_Figures_6.22.23.png",width=4,height=4, units = "in")
ggsave(external_intx_ct,device="png",filename="Figures/NO2_External_Count_Figures_2.27.23.png",width=4,height=4, units = "in")

#anxdep
ggsave(anxdep_intx_zi,device="png",filename="Figures/NO2_AnxDep_ZI_Figures_2.27.23.png",width=4,height=4, units = "in")
ggsave(anxdep_intx_ct,device="png",filename="Figures/NO2_AnxDep_Count_Figures_2.27.23.png",width=4,height=4, units = "in")

#withdep
ggsave(withdep_intx_zi,device="png",filename="Figures/NO2_WithDep_ZI_Figures_2.27.23.png",width=4,height=4, units = "in")
ggsave(withdep_intx_ct,device="png",filename="Figures/NO2_WithDep_Count_Figures_2.27.23.png",width=4,height=4, units = "in")

#rulebreak
ggsave(rulebreak_intx_zi,device="png",filename="Figures/NO2_Rulebreak_ZI_Figures_2.27.23.png",width=4,height=4, units = "in")
ggsave(rulebreak_intx_ct,device="png",filename="Figures/NO2_Rulebreak_Count_Figures_2.27.23.png",width=4,height=4, units = "in")

#aggressive
ggsave(aggressive_intx_zi,device="png",filename="Figures/NO2_Aggressive_ZI_Figures_6.22.23.png",width=4,height=4, units = "in")
ggsave(aggressive_intx_ct,device="png",filename="Figures/NO2_Aggressive_Count_Figures_2.27.23.png",width=4,height=4, units = "in")

#attention
ggsave(attention_intx_zi,device="png",filename="Figures/NO2_Attention_ZI_Figures_2.27.23.png",width=4,height=4, units = "in")
ggsave(attention_intx_ct,device="png",filename="Figures/NO2_Attention_Count_Figures_2.27.23.png",width=4,height=4, units = "in")
```
